$ JOB XLBUILD - Build XL Spreadsheet for CP-V                                   
$ ACCOUNT :SYS,LBE                                                              
$                                                                               
$ * Create and compile STRUTIL.FOR                                              
$ EDIT STRUTIL.FOR                                                              
C     STRUTIL.FOR - String Utilities (Layer 0)                                  
C                                                                               
C     Foundation layer providing string manipulation and conversion.            
C     No dependencies - all other modules build on this.                        
C                                                                               
C     FORTRAN IV (FORTRAN 66) compatible:                                       
C     - Fixed format (columns 1-72)                                             
C     - No CHARACTER type (use INTEGER arrays)                                  
C     - No block IF/ELSE (use arithmetic IF or GO TO)                           
C     - Identifiers limited to 6 characters                                     
C                                                                               
C     String representation:                                                    
C     Strings stored as INTEGER arrays with ASCII values.                       
C     Length passed separately as INTEGER parameter.                            
C                                                                               
C---------------------------------------------------------------------          
C                                                                               
C     STREQ - String equality comparison                                        
C                                                                               
C     Compare two strings for equality.                                         
C                                                                               
C     Parameters:                                                               
C       STR1(*)  - First string (INTEGER array)                                 
C       LEN1     - Length of first string                                       
C       STR2(*)  - Second string (INTEGER array)                                
C       LEN2     - Length of second string                                      
C                                                                               
C     Returns:                                                                  
C       1 if strings are equal, 0 otherwise                                     
C                                                                               
      INTEGER FUNCTION STREQ(STR1, LEN1, STR2, LEN2)                            
      INTEGER STR1(*), STR2(*)                                                  
      INTEGER LEN1, LEN2                                                        
      INTEGER I                                                                 
                                                                                
C     Different lengths means not equal                                         
      IF (LEN1 .NE. LEN2) GO TO 900                                             
                                                                                
C     Compare character by character                                            
      DO 100 I = 1, LEN1                                                        
        IF (STR1(I) .NE. STR2(I)) GO TO 900                                     
  100 CONTINUE                                                                  
                                                                                
C     Equal                                                                     
      STREQ = 1                                                                 
      RETURN                                                                    
                                                                                
C     Not equal                                                                 
  900 STREQ = 0                                                                 
      RETURN                                                                    
      END                                                                       
                                                                                
C---------------------------------------------------------------------          
C                                                                               
C     STRCPY - String copy                                                      
C                                                                               
C     Copy string from source to destination.                                   
C                                                                               
C     Parameters:                                                               
C       SRC(*)   - Source string (INTEGER array)                                
C       SRCLEN   - Length of source string                                      
C       DEST(*)  - Destination string (INTEGER array)                           
C       DSTLEN   - Maximum length of destination                                
C                                                                               
C     Side effects:                                                             
C       Modifies DEST array                                                     
C       Truncates if source longer than destination                             
C       Pads with spaces if source shorter                                      
C                                                                               
      SUBROUTINE STRCPY(SRC, SRCLEN, DEST, DSTLEN)                              
      INTEGER SRC(*), DEST(*)                                                   
      INTEGER SRCLEN, DSTLEN                                                    
      INTEGER I, CPYLEN                                                         
                                                                                
C     Determine copy length (minimum of source and dest)                        
      CPYLEN = SRCLEN                                                           
      IF (DSTLEN .LT. SRCLEN) CPYLEN = DSTLEN                                   
                                                                                
C     Copy characters                                                           
      DO 100 I = 1, CPYLEN                                                      
        DEST(I) = SRC(I)                                                        
  100 CONTINUE                                                                  
                                                                                
C     Pad with spaces if destination larger                                     
      IF (DSTLEN .LE. CPYLEN) GO TO 210                                         
      DO 200 I = CPYLEN + 1, DSTLEN                                             
        DEST(I) = 32                                                            
  200 CONTINUE                                                                  
  210 CONTINUE                                                                  
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C---------------------------------------------------------------------          
C                                                                               
C     STRFND - Find substring position                                          
C                                                                               
C     Find first occurrence of substring in string.                             
C                                                                               
C     Parameters:                                                               
C       STR(*)   - String to search (INTEGER array)                             
C       STRLEN   - Length of string                                             
C       SUB(*)   - Substring to find (INTEGER array)                            
C       SUBLEN   - Length of substring                                          
C                                                                               
C     Returns:                                                                  
C       Position of first occurrence (1-based), or 0 if not found               
C                                                                               
      INTEGER FUNCTION STRFND(STR, STRLEN, SUB, SUBLEN)                         
      INTEGER STR(*), SUB(*)                                                    
      INTEGER STRLEN, SUBLEN                                                    
      INTEGER I, J, MATCH                                                       
                                                                                
C     Substring longer than string - not found                                  
      IF (SUBLEN .GT. STRLEN) GO TO 900                                         
                                                                                
C     Empty substring - not found                                               
      IF (SUBLEN .EQ. 0) GO TO 900                                              
                                                                                
C     Search for substring                                                      
      DO 200 I = 1, STRLEN - SUBLEN + 1                                         
C       Try to match at position I                                              
        MATCH = 1                                                               
        DO 100 J = 1, SUBLEN                                                    
          IF (STR(I + J - 1) .EQ. SUB(J)) GO TO 100                             
          MATCH = 0                                                             
          GO TO 110                                                             
  100   CONTINUE                                                                
  110   CONTINUE                                                                
                                                                                
C       Found match                                                             
        IF (MATCH .NE. 1) GO TO 200                                             
        STRFND = I                                                              
        RETURN                                                                  
  200 CONTINUE                                                                  
                                                                                
C     Not found                                                                 
  900 STRFND = 0                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C---------------------------------------------------------------------          
C                                                                               
C     STRTRM - Trim trailing spaces                                             
C                                                                               
C     Find length of string excluding trailing spaces.                          
C                                                                               
C     Parameters:                                                               
C       STR(*)   - String (INTEGER array)                                       
C       LEN      - Maximum length to check                                      
C                                                                               
C     Returns:                                                                  
C       Length excluding trailing spaces                                        
C                                                                               
      INTEGER FUNCTION STRTRM(STR, LEN)                                         
      INTEGER STR(*)                                                            
      INTEGER LEN                                                               
      INTEGER I                                                                 
                                                                                
C     Scan backwards for first non-space                                        
      DO 100 I = LEN, 1, -1                                                     
        IF (STR(I) .EQ. 32) GO TO 100                                           
        STRTRM = I                                                              
        RETURN                                                                  
  100 CONTINUE                                                                  
                                                                                
C     All spaces (or empty)                                                     
      STRTRM = 0                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C---------------------------------------------------------------------          
C                                                                               
C     ITOA - Integer to ASCII string                                            
C                                                                               
C     Convert integer to string representation.                                 
C                                                                               
C     Parameters:                                                               
C       NUM      - Integer to convert                                           
C       STR(*)   - Output string (INTEGER array)                                
C       MAXLEN   - Maximum length of output                                     
C       LEN      - Actual length of result (output parameter)                   
C                                                                               
C     Side effects:                                                             
C       Modifies STR and LEN                                                    
C                                                                               
      SUBROUTINE ITOA(NUM, STR, MAXLEN, LEN)                                    
      INTEGER NUM, STR(*), MAXLEN, LEN                                          
      INTEGER N, I, J, TEMP, DIGIT, STRT                                        
                                                                                
C     Handle zero                                                               
      IF (NUM .NE. 0) GO TO 50                                                  
      STR(1) = 48                                                               
      LEN = 1                                                                   
      RETURN                                                                    
   50 CONTINUE                                                                  
                                                                                
C     Handle negative                                                           
      N = NUM                                                                   
      STRT = 1                                                                  
      IF (N .GE. 0) GO TO 60                                                    
      STR(1) = 45                                                               
      STRT = 2                                                                  
      N = -N                                                                    
   60 CONTINUE                                                                  
                                                                                
C     Extract digits (right to left)                                            
      I = STRT                                                                  
  100 IF (N .LE. 0) GO TO 110                                                   
      DIGIT = MOD(N, 10)                                                        
      STR(I) = 48 + DIGIT                                                       
      I = I + 1                                                                 
      N = N / 10                                                                
      GO TO 100                                                                 
  110 LEN = I - 1                                                               
                                                                                
C     Reverse digits (preserve sign if negative)                                
      I = STRT                                                                  
      J = LEN                                                                   
  200 IF (I .GE. J) GO TO 210                                                   
      TEMP = STR(I)                                                             
      STR(I) = STR(J)                                                           
      STR(J) = TEMP                                                             
      I = I + 1                                                                 
      J = J - 1                                                                 
      GO TO 200                                                                 
  210 CONTINUE                                                                  
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C---------------------------------------------------------------------          
C                                                                               
C     ATOI - ASCII string to integer                                            
C                                                                               
C     Convert string to integer.                                                
C                                                                               
C     Parameters:                                                               
C       STR(*)   - String to convert (INTEGER array)                            
C       LEN      - Length of string                                             
C                                                                               
C     Returns:                                                                  
C       Integer value                                                           
C                                                                               
      INTEGER FUNCTION ATOI(STR, LEN)                                           
      INTEGER STR(*), LEN                                                       
      INTEGER I, SIGN, RESULT                                                   
                                                                                
C     Initialize                                                                
      RESULT = 0                                                                
      SIGN = 1                                                                  
      I = 1                                                                     
                                                                                
C     Skip leading spaces                                                       
  100 IF (I .GT. LEN) GO TO 110                                                 
      IF (STR(I) .NE. 32) GO TO 110                                             
      I = I + 1                                                                 
      GO TO 100                                                                 
  110 CONTINUE                                                                  
                                                                                
C     Check for sign                                                            
      IF (I .GT. LEN) GO TO 150                                                 
      IF (STR(I) .NE. 45) GO TO 120                                             
      SIGN = -1                                                                 
      I = I + 1                                                                 
      GO TO 150                                                                 
  120 IF (STR(I) .NE. 43) GO TO 150                                             
      I = I + 1                                                                 
  150 CONTINUE                                                                  
                                                                                
C     Convert digits                                                            
  200 IF (I .GT. LEN) GO TO 210                                                 
C     Check if digit (ASCII 48-57)                                              
      IF (STR(I) .LT. 48 .OR. STR(I) .GT. 57) GO TO 210                         
      RESULT = RESULT * 10 + (STR(I) - 48)                                      
      I = I + 1                                                                 
      GO TO 200                                                                 
  210 CONTINUE                                                                  
                                                                                
      ATOI = RESULT * SIGN                                                      
      RETURN                                                                    
      END                                                                       
                                                                                
C---------------------------------------------------------------------          
C                                                                               
C     RTOA - Real to ASCII string                                               
C                                                                               
C     Convert real number to string with given precision.                       
C                                                                               
C     Parameters:                                                               
C       NUM      - Real number to convert                                       
C       STR(*)   - Output string (INTEGER array)                                
C       MAXLEN   - Maximum length of output                                     
C       PREC     - Decimal places                                               
C       LEN      - Actual length of result (output parameter)                   
C                                                                               
C     Side effects:                                                             
C       Modifies STR and LEN                                                    
C                                                                               
      SUBROUTINE RTOA(NUM, STR, MAXLEN, PREC, LEN)                              
      REAL NUM                                                                  
      INTEGER STR(*), MAXLEN, PREC, LEN                                         
      INTEGER INTPRT, I, SAVE                                                   
      REAL FRACPT, SCALE                                                        
                                                                                
C     Handle negative                                                           
      IF (NUM .GE. 0.0) GO TO 50                                                
      STR(1) = 45                                                               
      LEN = 1                                                                   
      INTPRT = INT(-NUM)                                                        
      FRACPT = -NUM - REAL(INTPRT)                                              
      GO TO 60                                                                  
   50 LEN = 0                                                                   
      INTPRT = INT(NUM)                                                         
      FRACPT = NUM - REAL(INTPRT)                                               
   60 CONTINUE                                                                  
                                                                                
C     Convert integer part                                                      
      SAVE = LEN                                                                
      CALL ITOA(INTPRT, STR(LEN+1), MAXLEN-LEN, I)                              
      LEN = LEN + I                                                             
                                                                                
C     Add decimal point                                                         
      IF (PREC .LE. 0) GO TO 70                                                 
      IF (LEN .GE. MAXLEN) GO TO 70                                             
      LEN = LEN + 1                                                             
      STR(LEN) = 46                                                             
   70 CONTINUE                                                                  
                                                                                
C     Convert fractional part                                                   
      SCALE = 10.0                                                              
      DO 100 I = 1, PREC                                                        
        IF (LEN .GE. MAXLEN) GO TO 110                                          
        INTPRT = INT(FRACPT * SCALE)                                            
        STR(LEN + 1) = 48 + MOD(INTPRT, 10)                                     
        LEN = LEN + 1                                                           
        SCALE = SCALE * 10.0                                                    
  100 CONTINUE                                                                  
  110 CONTINUE                                                                  
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C---------------------------------------------------------------------          
C                                                                               
C     ATOR - ASCII string to real                                               
C                                                                               
C     Convert string to real number.                                            
C                                                                               
C     Parameters:                                                               
C       STR(*)   - String to convert (INTEGER array)                            
C       LEN      - Length of string                                             
C                                                                               
C     Returns:                                                                  
C       Real value                                                              
C                                                                               
      REAL FUNCTION ATOR(STR, LEN)                                              
      INTEGER STR(*), LEN                                                       
      INTEGER I, SIGN                                                           
      REAL RESULT, FRAC, SCALE                                                  
                                                                                
C     Initialize                                                                
      RESULT = 0.0                                                              
      FRAC = 0.0                                                                
      SCALE = 1.0                                                               
      SIGN = 1                                                                  
      I = 1                                                                     
                                                                                
C     Skip leading spaces                                                       
  100 IF (I .GT. LEN) GO TO 110                                                 
      IF (STR(I) .NE. 32) GO TO 110                                             
      I = I + 1                                                                 
      GO TO 100                                                                 
  110 CONTINUE                                                                  
                                                                                
C     Check for sign                                                            
      IF (I .GT. LEN) GO TO 150                                                 
      IF (STR(I) .NE. 45) GO TO 120                                             
      SIGN = -1                                                                 
      I = I + 1                                                                 
      GO TO 150                                                                 
  120 IF (STR(I) .NE. 43) GO TO 150                                             
      I = I + 1                                                                 
  150 CONTINUE                                                                  
                                                                                
C     Convert integer part                                                      
  200 IF (I .GT. LEN) GO TO 210                                                 
      IF (STR(I) .LT. 48 .OR. STR(I) .GT. 57) GO TO 210                         
      RESULT = RESULT * 10.0 + REAL(STR(I) - 48)                                
      I = I + 1                                                                 
      GO TO 200                                                                 
  210 CONTINUE                                                                  
                                                                                
C     Check for decimal point                                                   
      IF (I .GT. LEN) GO TO 400                                                 
      IF (STR(I) .NE. 46) GO TO 400                                             
      I = I + 1                                                                 
                                                                                
C     Convert fractional part                                                   
      SCALE = 0.1                                                               
  300 IF (I .GT. LEN) GO TO 400                                                 
      IF (STR(I) .LT. 48 .OR. STR(I) .GT. 57) GO TO 400                         
      FRAC = FRAC + REAL(STR(I) - 48) * SCALE                                   
      SCALE = SCALE * 0.1                                                       
      I = I + 1                                                                 
      GO TO 300                                                                 
  400 CONTINUE                                                                  
                                                                                
      ATOR = REAL(SIGN) * (RESULT + FRAC)                                       
      RETURN                                                                    
      END                                                                       
                                                                                
C---------------------------------------------------------------------          
C                                                                               
C     COLTOA - Column number to letters (A, B, ..., Z, AA, ...)                 
C                                                                               
C     Convert column number (1-based) to column letters.                        
C                                                                               
C     Parameters:                                                               
C       COL      - Column number (1=A, 26=Z, 27=AA, etc.)                       
C       STR(*)   - Output string (INTEGER array)                                
C       MAXLEN   - Maximum length of output                                     
C       LEN      - Actual length of result (output parameter)                   
C                                                                               
C     Side effects:                                                             
C       Modifies STR and LEN                                                    
C                                                                               
      SUBROUTINE COLTOA(COL, STR, MAXLEN, LEN)                                  
      INTEGER COL, STR(*), MAXLEN, LEN                                          
      INTEGER N, I, DIGIT                                                       
                                                                                
C     Handle invalid column                                                     
      IF (COL .GE. 1) GO TO 50                                                  
      LEN = 0                                                                   
      RETURN                                                                    
   50 CONTINUE                                                                  
                                                                                
      N = COL                                                                   
      LEN = 0                                                                   
                                                                                
C     Extract letters (right to left, base-26)                                  
  100 IF (N .LE. 0) GO TO 110                                                   
      LEN = LEN + 1                                                             
      IF (LEN .LE. MAXLEN) GO TO 105                                            
      LEN = MAXLEN                                                              
      RETURN                                                                    
  105 CONTINUE                                                                  
                                                                                
C     Convert to 0-based, get digit, convert back to 1-based                    
      N = N - 1                                                                 
      DIGIT = MOD(N, 26)                                                        
      STR(LEN) = 65 + DIGIT                                                     
      N = N / 26                                                                
      GO TO 100                                                                 
  110 CONTINUE                                                                  
                                                                                
C     Reverse letters                                                           
      I = 1                                                                     
  200 IF (I .GE. LEN) GO TO 210                                                 
      N = STR(I)                                                                
      STR(I) = STR(LEN - I + 1)                                                 
      STR(LEN - I + 1) = N                                                      
      I = I + 1                                                                 
      IF (I .LT. LEN - I + 1) GO TO 200                                         
  210 CONTINUE                                                                  
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C---------------------------------------------------------------------          
C                                                                               
C     ATOCOL - Letters to column number                                         
C                                                                               
C     Convert column letters to number.                                         
C                                                                               
C     Parameters:                                                               
C       STR(*)   - Column letters (INTEGER array)                               
C       LEN      - Length of string                                             
C                                                                               
C     Returns:                                                                  
C       Column number (1-based), or 0 if invalid                                
C                                                                               
      INTEGER FUNCTION ATOCOL(STR, LEN)                                         
      INTEGER STR(*), LEN                                                       
      INTEGER I, RESULT, DIGIT                                                  
                                                                                
      RESULT = 0                                                                
                                                                                
C     Process each letter                                                       
      DO 100 I = 1, LEN                                                         
C       Check if uppercase letter (ASCII 65-90)                                 
        IF (STR(I) .LT. 65 .OR. STR(I) .GT. 90) GO TO 900                       
        DIGIT = STR(I) - 65                                                     
        RESULT = RESULT * 26 + DIGIT + 1                                        
  100 CONTINUE                                                                  
                                                                                
      ATOCOL = RESULT                                                           
      RETURN                                                                    
                                                                                
C     Invalid character                                                         
  900 ATOCOL = 0                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C---------------------------------------------------------------------          
C                                                                               
C     FMTCEL - Format cell reference (e.g., "A1", "B23")                        
C                                                                               
C     Convert column and row numbers to cell reference string.                  
C                                                                               
C     Parameters:                                                               
C       COL      - Column number (1-based)                                      
C       ROW      - Row number (1-based)                                         
C       STR(*)   - Output string (INTEGER array)                                
C       MAXLEN   - Maximum length of output                                     
C       LEN      - Actual length of result (output parameter)                   
C                                                                               
C     Side effects:                                                             
C       Modifies STR and LEN                                                    
C                                                                               
      SUBROUTINE FMTCEL(COL, ROW, STR, MAXLEN, LEN)                             
      INTEGER COL, ROW, STR(*), MAXLEN, LEN                                     
      INTEGER COLLEN, ROWLEN, I                                                 
                                                                                
C     Convert column to letters                                                 
      CALL COLTOA(COL, STR, MAXLEN, COLLEN)                                     
      LEN = COLLEN                                                              
                                                                                
C     Convert row to digits                                                     
      IF (LEN .GE. MAXLEN) GO TO 100                                            
      CALL ITOA(ROW, STR(LEN+1), MAXLEN-LEN, ROWLEN)                            
      LEN = LEN + ROWLEN                                                        
  100 CONTINUE                                                                  
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C---------------------------------------------------------------------          
C                                                                               
C     PARCEL - Parse cell reference (e.g., "A1" -> col=1, row=1)                
C                                                                               
C     Parse cell reference string to column and row numbers.                    
C                                                                               
C     Parameters:                                                               
C       STR(*)   - Cell reference string (INTEGER array)                        
C       LEN      - Length of string                                             
C       COL      - Column number (output parameter)                             
C       ROW      - Row number (output parameter)                                
C                                                                               
C     Returns (via COL, ROW):                                                   
C       COL=0, ROW=0 if parse fails                                             
C                                                                               
C     Side effects:                                                             
C       Modifies COL and ROW                                                    
C                                                                               
      SUBROUTINE PARCEL(STR, LEN, COL, ROW)                                     
      INTEGER STR(*), LEN, COL, ROW                                             
      INTEGER I, COLSTR(10)                                                     
      INTEGER ATOI, ATOCOL                                                      
                                                                                
C     Find where letters end and digits begin                                   
      I = 1                                                                     
  100 IF (I .GT. LEN) GO TO 110                                                 
      IF (STR(I) .LT. 65 .OR. STR(I) .GT. 90) GO TO 110                         
      I = I + 1                                                                 
      GO TO 100                                                                 
  110 CONTINUE                                                                  
                                                                                
C     Check for valid format (at least one letter, one digit)                   
      IF (I .NE. 1 .AND. I .LE. LEN) GO TO 120                                  
      COL = 0                                                                   
      ROW = 0                                                                   
      RETURN                                                                    
  120 CONTINUE                                                                  
                                                                                
C     Parse column letters                                                      
      COL = ATOCOL(STR, I - 1)                                                  
                                                                                
C     Parse row number                                                          
      ROW = ATOI(STR(I), LEN - I + 1)                                           
                                                                                
      RETURN                                                                    
      END                                                                       
:FILE                                                                           
:QUIT                                                                           
$                                                                               
$ RUN FORTRAN                                                                   
*SOURCE=STRUTIL.FOR                                                             
*OBJECT=STRUTIL.OBJ                                                             
*LINK                                                                           
$                                                                               
$ * Create and compile CELLS.FOR                                                
$ EDIT CELLS.FOR                                                                
C     CELLS.FOR - Cell Storage Module                                           
C                                                                               
C     Purpose: Store and retrieve spreadsheet cells using hash table            
C                                                                               
C     Features:                                                                 
C       - Hash table with open chaining for collisions                          
C       - Sparse storage (only non-empty cells stored)                          
C       - Support for numeric and formula cells                                 
C       - String pool for formula storage                                       
C                                                                               
C     Configuration:                                                            
C       Array sizes defined by PARAMETER statements below.                      
C       To change configuration, modify these parameters and recompile.         
C       See src/config/CONFIG_*.FOR for suggested configurations.               
C                                                                               
C     Dependencies: STRUTIL.FOR                                                 
C                                                                               
C     Author: Claude Code                                                       
C     Date: 2026-01-18                                                          
C     Updated: 2026-01-19 (Added configurable array sizes)                      
C                                                                               
C======================================================================         
C                                                                               
C     Configuration Note:                                                       
C       Array sizes are controlled by PARAMETER statements in each subroutine.  
C       To change configuration, modify all PARAMETER statements in this file.  
C       Suggested configurations (see src/config/ for details):                 
C         - Full (default): MAXCEL=2000, HASHSZ=1024, MAXSTR=10000              
C         - CP/M (48KB):    MAXCEL=300,  HASHSZ=256,  MAXSTR=2000               
C         - Minimal:        MAXCEL=100,  HASHSZ=64,   MAXSTR=500                
C                                                                               
C======================================================================         
                                                                                
C======================================================================         
C     CELINI - Initialize cell storage                                          
C======================================================================         
      SUBROUTINE CELINI                                                         
C     Cell array - stores all cells in hash table                               
C     CELLA(i,1) = COL    (column number 1-63)                                  
C     CELLA(i,2) = ROW    (row number 1-254)                                    
C     CELLA(i,3) = TYPE   (0=empty, 1=number, 2=formula)                        
C     CELLA(i,4) = FMLIDX (formula index for TYPE=2, unused for TYPE=1)         
C     CELLA(i,5) = NEXT   (next cell index for collision chain)                 
C     CELLA(i,6) = FLAGS  (recalc needed, etc)                                  
C     CELLA(i,7) = UNUSED (was RESULT, now in CELLR)                            
C     CELLV(i)   = VALUE  (REAL value for TYPE=1 numeric cells)                 
C     CELLR(i)   = RESULT (REAL result for TYPE=2 formulas)                     
C                                                                               
C     Configuration parameters                                                  
      INTEGER MAXCEL, HASHSZ, MAXSTR                                            
      PARAMETER (MAXCEL=2000, HASHSZ=1024, MAXSTR=10000)                        
C                                                                               
      INTEGER CELLA(MAXCEL, 7)                                                  
      INTEGER HTABLE(HASHSZ)                                                    
      INTEGER FRLIST, CELCNT                                                    
      INTEGER FMLPOL(MAXSTR)                                                    
      INTEGER FMLLEN(MAXCEL)                                                    
      INTEGER FMLPTR                                                            
      REAL CELLV(MAXCEL)                                                        
      REAL CELLR(MAXCEL)                                                        
                                                                                
      COMMON /CELDAT/ CELLA, HTABLE, FRLIST, CELCNT,                            
     &                FMLPOL, FMLLEN, FMLPTR                                    
      COMMON /CELVDAT/ CELLV, CELLR                                             
                                                                                
      INTEGER I                                                                 
                                                                                
C     Clear hash table                                                          
      DO 10 I = 1, HASHSZ                                                       
        HTABLE(I) = 0                                                           
10    CONTINUE                                                                  
                                                                                
C     Clear cell array (mark all as empty)                                      
      DO 20 I = 1, MAXCEL                                                       
        CELLA(I,1) = 0                                                          
        CELLA(I,2) = 0                                                          
        CELLA(I,3) = 0        ! TYPE=0 (empty)                                  
        CELLA(I,4) = 0                                                          
        CELLA(I,5) = 0                                                          
        CELLA(I,6) = 0                                                          
        CELLA(I,7) = 0                                                          
        CELLV(I) = 0.0                                                          
        CELLR(I) = 0.0                                                          
        FMLLEN(I) = 0                                                           
20    CONTINUE                                                                  
                                                                                
C     Initialize free list (not used initially)                                 
      FRLIST = 0                                                                
      CELCNT = 0                                                                
                                                                                
C     Initialize formula pool                                                   
      FMLPTR = 1                                                                
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     CELHSH - Compute hash value for cell                                      
C======================================================================         
      INTEGER FUNCTION CELHSH(COL, ROW)                                         
      INTEGER COL, ROW                                                          
                                                                                
C     Configuration parameters                                                  
      INTEGER HASHSZ                                                            
      PARAMETER (HASHSZ=1024)                                                   
C                                                                               
C     Hash function: (COL * 257 + ROW) MOD HASHSZ                               
C     257 is prime, provides good distribution                                  
      CELHSH = MOD(COL * 257 + ROW, HASHSZ)                                     
                                                                                
C     Ensure positive and 1-indexed                                             
      IF (CELHSH .LE. 0) CELHSH = CELHSH + HASHSZ                               
      IF (CELHSH .LT. 1) CELHSH = 1                                             
      IF (CELHSH .GT. HASHSZ) CELHSH = HASHSZ                                   
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     CELFND - Find cell index in hash table                                    
C======================================================================         
      INTEGER FUNCTION CELFND(COL, ROW)                                         
      INTEGER COL, ROW                                                          
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXCEL, HASHSZ, MAXSTR                                            
      PARAMETER (MAXCEL=2000, HASHSZ=1024, MAXSTR=10000)                        
C                                                                               
      INTEGER CELLA(MAXCEL, 7)                                                  
      INTEGER HTABLE(HASHSZ)                                                    
      INTEGER FRLIST, CELCNT                                                    
      INTEGER FMLPOL(MAXSTR)                                                    
      INTEGER FMLLEN(MAXCEL)                                                    
      INTEGER FMLPTR                                                            
      REAL CELLV(MAXCEL)                                                        
      REAL CELLR(MAXCEL)                                                        
                                                                                
      COMMON /CELDAT/ CELLA, HTABLE, FRLIST, CELCNT,                            
     &                FMLPOL, FMLLEN, FMLPTR                                    
      COMMON /CELVDAT/ CELLV, CELLR                                             
                                                                                
      INTEGER HASH, IDX                                                         
      INTEGER CELHSH                                                            
                                                                                
C     Compute hash                                                              
      HASH = CELHSH(COL, ROW)                                                   
                                                                                
C     Get head of chain                                                         
      IDX = HTABLE(HASH)                                                        
                                                                                
C     Search chain                                                              
100   IF (IDX .EQ. 0) GO TO 900                                                 
                                                                                
C     Check if this is the cell                                                 
      IF (CELLA(IDX,1) .EQ. COL .AND. CELLA(IDX,2) .EQ. ROW) GO TO 800          
                                                                                
C     Move to next in chain                                                     
      IDX = CELLA(IDX,5)                                                        
      GO TO 100                                                                 
                                                                                
C     Found                                                                     
800   CELFND = IDX                                                              
      RETURN                                                                    
                                                                                
C     Not found                                                                 
900   CELFND = 0                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     CELNEW - Allocate new cell slot                                           
C======================================================================         
      INTEGER FUNCTION CELNEW()                                                 
C     Configuration parameters                                                  
      INTEGER MAXCEL, HASHSZ, MAXSTR                                            
      PARAMETER (MAXCEL=2000, HASHSZ=1024, MAXSTR=10000)                        
C                                                                               
      INTEGER CELLA(MAXCEL, 7)                                                  
      INTEGER HTABLE(HASHSZ)                                                    
      INTEGER FRLIST, CELCNT                                                    
      INTEGER FMLPOL(MAXSTR)                                                    
      INTEGER FMLLEN(MAXCEL)                                                    
      INTEGER FMLPTR                                                            
      REAL CELLV(MAXCEL)                                                        
      REAL CELLR(MAXCEL)                                                        
                                                                                
      COMMON /CELDAT/ CELLA, HTABLE, FRLIST, CELCNT,                            
     &                FMLPOL, FMLLEN, FMLPTR                                    
      COMMON /CELVDAT/ CELLV, CELLR                                             
                                                                                
      INTEGER I                                                                 
                                                                                
C     Check if free list has slots                                              
      IF (FRLIST .NE. 0) GO TO 100                                              
                                                                                
C     No free list, allocate from end                                           
      CELCNT = CELCNT + 1                                                       
      IF (CELCNT .GT. MAXCEL) GO TO 900                                         
                                                                                
      CELNEW = CELCNT                                                           
      RETURN                                                                    
                                                                                
C     Use slot from free list                                                   
100   I = FRLIST                                                                
      FRLIST = CELLA(I,5)                                                       
      CELNEW = I                                                                
      RETURN                                                                    
                                                                                
C     Out of space                                                              
900   CELNEW = 0                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     CELPUT - Store cell value                                                 
C======================================================================         
      SUBROUTINE CELPUT(COL, ROW, TYPE, VALUE)                                  
      INTEGER COL, ROW, TYPE                                                    
      REAL VALUE                                                                
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXCEL, HASHSZ, MAXSTR                                            
      PARAMETER (MAXCEL=2000, HASHSZ=1024, MAXSTR=10000)                        
C                                                                               
      INTEGER CELLA(MAXCEL, 7)                                                  
      INTEGER HTABLE(HASHSZ)                                                    
      INTEGER FRLIST, CELCNT                                                    
      INTEGER FMLPOL(MAXSTR)                                                    
      INTEGER FMLLEN(MAXCEL)                                                    
      INTEGER FMLPTR                                                            
      REAL CELLV(MAXCEL)                                                        
      REAL CELLR(MAXCEL)                                                        
                                                                                
      COMMON /CELDAT/ CELLA, HTABLE, FRLIST, CELCNT,                            
     &                FMLPOL, FMLLEN, FMLPTR                                    
      COMMON /CELVDAT/ CELLV, CELLR                                             
                                                                                
      INTEGER HASH, IDX, NEWIDX                                                 
      INTEGER CELHSH, CELFND, CELNEW                                            
                                                                                
C     Check if cell already exists                                              
      IDX = CELFND(COL, ROW)                                                    
                                                                                
C     If exists, update it                                                      
      IF (IDX .NE. 0) GO TO 200                                                 
                                                                                
C     Cell doesn't exist, create new                                            
      NEWIDX = CELNEW()                                                         
      IF (NEWIDX .EQ. 0) RETURN                                                 
                                                                                
C     Initialize new cell                                                       
      CELLA(NEWIDX,1) = COL                                                     
      CELLA(NEWIDX,2) = ROW                                                     
      CELLA(NEWIDX,3) = TYPE                                                    
      CELLA(NEWIDX,4) = 0                                                       
      CELLA(NEWIDX,5) = 0                                                       
      CELLA(NEWIDX,6) = 0                                                       
                                                                                
C     Store REAL value (fixes precision loss bug!)                              
      CELLV(NEWIDX) = VALUE                                                     
                                                                                
C     Add to hash table chain                                                   
      HASH = CELHSH(COL, ROW)                                                   
      CELLA(NEWIDX,5) = HTABLE(HASH)                                            
      HTABLE(HASH) = NEWIDX                                                     
                                                                                
      RETURN                                                                    
                                                                                
C     Update existing cell                                                      
200   CELLA(IDX,3) = TYPE                                                       
      CELLV(IDX) = VALUE                                                        
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     CELGET - Retrieve cell value                                              
C======================================================================         
      SUBROUTINE CELGET(COL, ROW, TYPE, VALUE)                                  
      INTEGER COL, ROW, TYPE                                                    
      REAL VALUE                                                                
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXCEL, HASHSZ, MAXSTR                                            
      PARAMETER (MAXCEL=2000, HASHSZ=1024, MAXSTR=10000)                        
C                                                                               
      INTEGER CELLA(MAXCEL, 7)                                                  
      INTEGER HTABLE(HASHSZ)                                                    
      INTEGER FRLIST, CELCNT                                                    
      INTEGER FMLPOL(MAXSTR)                                                    
      INTEGER FMLLEN(MAXCEL)                                                    
      INTEGER FMLPTR                                                            
      REAL CELLV(MAXCEL)                                                        
      REAL CELLR(MAXCEL)                                                        
                                                                                
      COMMON /CELDAT/ CELLA, HTABLE, FRLIST, CELCNT,                            
     &                FMLPOL, FMLLEN, FMLPTR                                    
      COMMON /CELVDAT/ CELLV, CELLR                                             
                                                                                
      INTEGER IDX                                                               
      INTEGER CELFND                                                            
                                                                                
C     Find cell                                                                 
      IDX = CELFND(COL, ROW)                                                    
                                                                                
C     If not found, return empty                                                
      IF (IDX .EQ. 0) GO TO 900                                                 
                                                                                
C     Return cell data                                                          
      TYPE = CELLA(IDX,3)                                                       
                                                                                
C     For formulas, return calculated result from CELLR                         
      IF (TYPE .EQ. 2) GO TO 910                                                
                                                                                
C     For numbers, return value from CELLV (fixes precision loss!)              
      VALUE = CELLV(IDX)                                                        
      RETURN                                                                    
                                                                                
C     Formula - return result from CELLR                                        
910   VALUE = CELLR(IDX)                                                        
      RETURN                                                                    
                                                                                
C     Cell not found                                                            
900   TYPE = 0                                                                  
      VALUE = 0.0                                                               
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     CELDEL - Delete cell                                                      
C======================================================================         
      SUBROUTINE CELDEL(COL, ROW)                                               
      INTEGER COL, ROW                                                          
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXCEL, HASHSZ, MAXSTR                                            
      PARAMETER (MAXCEL=2000, HASHSZ=1024, MAXSTR=10000)                        
C                                                                               
      INTEGER CELLA(MAXCEL, 7)                                                  
      INTEGER HTABLE(HASHSZ)                                                    
      INTEGER FRLIST, CELCNT                                                    
      INTEGER FMLPOL(MAXSTR)                                                    
      INTEGER FMLLEN(MAXCEL)                                                    
      INTEGER FMLPTR                                                            
      REAL CELLV(MAXCEL)                                                        
      REAL CELLR(MAXCEL)                                                        
                                                                                
      COMMON /CELDAT/ CELLA, HTABLE, FRLIST, CELCNT,                            
     &                FMLPOL, FMLLEN, FMLPTR                                    
      COMMON /CELVDAT/ CELLV, CELLR                                             
                                                                                
      INTEGER HASH, IDX, PREV                                                   
      INTEGER CELHSH                                                            
                                                                                
C     Compute hash                                                              
      HASH = CELHSH(COL, ROW)                                                   
                                                                                
C     Get head of chain                                                         
      IDX = HTABLE(HASH)                                                        
      PREV = 0                                                                  
                                                                                
C     Search chain                                                              
100   IF (IDX .EQ. 0) RETURN                                                    
                                                                                
C     Check if this is the cell                                                 
      IF (CELLA(IDX,1) .EQ. COL .AND. CELLA(IDX,2) .EQ. ROW) GO TO 200          
                                                                                
C     Move to next                                                              
      PREV = IDX                                                                
      IDX = CELLA(IDX,5)                                                        
      GO TO 100                                                                 
                                                                                
C     Found cell to delete                                                      
200   CONTINUE                                                                  
                                                                                
C     Remove from chain                                                         
      IF (PREV .EQ. 0) GO TO 210                                                
                                                                                
C     Not head of chain                                                         
      CELLA(PREV,5) = CELLA(IDX,5)                                              
      GO TO 220                                                                 
                                                                                
C     Head of chain                                                             
210   HTABLE(HASH) = CELLA(IDX,5)                                               
                                                                                
C     Mark cell as empty                                                        
220   CELLA(IDX,1) = 0                                                          
      CELLA(IDX,2) = 0                                                          
      CELLA(IDX,3) = 0                                                          
      CELLA(IDX,4) = 0                                                          
      CELLA(IDX,6) = 0                                                          
                                                                                
C     Add to free list                                                          
      CELLA(IDX,5) = FRLIST                                                     
      FRLIST = IDX                                                              
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     FMLADD - Add formula to string pool (STUB for future)                     
C======================================================================         
      SUBROUTINE FMLADD(FMLSTR, FMLLN, FMLIDX)                                  
      INTEGER FMLSTR(*), FMLLN, FMLIDX                                          
                                                                                
C     TODO: Implement formula string pool                                       
C     For now, just return index 1                                              
      FMLIDX = 1                                                                
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     CELRES - Store formula result                                             
C======================================================================         
      SUBROUTINE CELRES(COL, ROW, RESULT)                                       
      INTEGER COL, ROW                                                          
      REAL RESULT                                                               
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXCEL, HASHSZ, MAXSTR                                            
      PARAMETER (MAXCEL=2000, HASHSZ=1024, MAXSTR=10000)                        
C                                                                               
      INTEGER CELLA(MAXCEL, 7)                                                  
      INTEGER HTABLE(HASHSZ)                                                    
      INTEGER FRLIST, CELCNT                                                    
      INTEGER FMLPOL(MAXSTR)                                                    
      INTEGER FMLLEN(MAXCEL)                                                    
      INTEGER FMLPTR                                                            
      REAL CELLV(MAXCEL)                                                        
      REAL CELLR(MAXCEL)                                                        
                                                                                
      COMMON /CELDAT/ CELLA, HTABLE, FRLIST, CELCNT,                            
     &                FMLPOL, FMLLEN, FMLPTR                                    
      COMMON /CELVDAT/ CELLV, CELLR                                             
                                                                                
      INTEGER IDX, CELFND                                                       
                                                                                
C     Find cell                                                                 
      IDX = CELFND(COL, ROW)                                                    
      IF (IDX .EQ. 0) RETURN                                                    
                                                                                
C     Store result in CELLR (fixes precision loss!)                             
      CELLR(IDX) = RESULT                                                       
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     CELPTK - Put formula tokens into cell                                     
C======================================================================         
      SUBROUTINE CELPTK(COL, ROW, TOKENS, NTOK)                                 
      INTEGER COL, ROW                                                          
      INTEGER TOKENS(100, 4)                                                    
      INTEGER NTOK                                                              
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXCEL, HASHSZ, MAXSTR                                            
      PARAMETER (MAXCEL=2000, HASHSZ=1024, MAXSTR=10000)                        
C                                                                               
      INTEGER CELLA(MAXCEL, 7)                                                  
      INTEGER HTABLE(HASHSZ)                                                    
      INTEGER FRLIST, CELCNT                                                    
      INTEGER FMLPOL(MAXSTR)                                                    
      INTEGER FMLLEN(MAXCEL)                                                    
      INTEGER FMLPTR                                                            
      REAL CELLV(MAXCEL)                                                        
      REAL CELLR(MAXCEL)                                                        
                                                                                
      COMMON /CELDAT/ CELLA, HTABLE, FRLIST, CELCNT,                            
     &                FMLPOL, FMLLEN, FMLPTR                                    
      COMMON /CELVDAT/ CELLV, CELLR                                             
                                                                                
      INTEGER IDX, CELFND, CELNEW, I, J, BASE, HASH, CELHSH                     
                                                                                
C     Find or create cell                                                       
      IDX = CELFND(COL, ROW)                                                    
                                                                                
C     If cell doesn't exist, create it                                          
      IF (IDX .EQ. 0) GO TO 10                                                  
      GO TO 20                                                                  
                                                                                
C     Create new cell                                                           
10    IDX = CELNEW()                                                            
      IF (IDX .EQ. 0) RETURN                                                    
                                                                                
C     Initialize new cell                                                       
      CELLA(IDX,1) = COL                                                        
      CELLA(IDX,2) = ROW                                                        
      CELLA(IDX,3) = 2      ! TYPE=formula                                      
      CELLA(IDX,4) = 0                                                          
      CELLA(IDX,5) = 0                                                          
      CELLA(IDX,6) = 0                                                          
      CELLA(IDX,7) = 0                                                          
                                                                                
C     Add to hash table                                                         
      HASH = CELHSH(COL, ROW)                                                   
      CELLA(IDX,5) = HTABLE(HASH)                                               
      HTABLE(HASH) = IDX                                                        
                                                                                
C     Store token count                                                         
20    FMLLEN(IDX) = NTOK                                                        
                                                                                
C     Allocate space in formula pool                                            
      BASE = FMLPTR                                                             
                                                                                
C     Copy tokens to pool (4 integers per token)                                
      DO 100 I = 1, NTOK                                                        
        DO 110 J = 1, 4                                                         
          FMLPOL(FMLPTR) = TOKENS(I,J)                                          
          FMLPTR = FMLPTR + 1                                                   
110     CONTINUE                                                                
100   CONTINUE                                                                  
                                                                                
C     Mark cell as formula type                                                 
      CELLA(IDX,3) = 2                                                          
      CELLA(IDX,4) = BASE                                                       
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     CELGTK - Get formula tokens from cell                                     
C======================================================================         
      SUBROUTINE CELGTK(COL, ROW, TOKENS, NTOK)                                 
      INTEGER COL, ROW                                                          
      INTEGER TOKENS(100, 4)                                                    
      INTEGER NTOK                                                              
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXCEL, HASHSZ, MAXSTR                                            
      PARAMETER (MAXCEL=2000, HASHSZ=1024, MAXSTR=10000)                        
C                                                                               
      INTEGER CELLA(MAXCEL, 7)                                                  
      INTEGER HTABLE(HASHSZ)                                                    
      INTEGER FRLIST, CELCNT                                                    
      INTEGER FMLPOL(MAXSTR)                                                    
      INTEGER FMLLEN(MAXCEL)                                                    
      INTEGER FMLPTR                                                            
      REAL CELLV(MAXCEL)                                                        
      REAL CELLR(MAXCEL)                                                        
                                                                                
      COMMON /CELDAT/ CELLA, HTABLE, FRLIST, CELCNT,                            
     &                FMLPOL, FMLLEN, FMLPTR                                    
      COMMON /CELVDAT/ CELLV, CELLR                                             
                                                                                
      INTEGER IDX, CELFND, I, J, BASE, POS                                      
                                                                                
C     Find cell                                                                 
      IDX = CELFND(COL, ROW)                                                    
      IF (IDX .EQ. 0) GO TO 900                                                 
                                                                                
C     Check if formula                                                          
      IF (CELLA(IDX,3) .NE. 2) GO TO 900                                        
                                                                                
C     Get token count                                                           
      NTOK = FMLLEN(IDX)                                                        
                                                                                
C     Get base pointer                                                          
      BASE = CELLA(IDX,4)                                                       
      POS = BASE                                                                
                                                                                
C     Copy tokens from pool                                                     
      DO 100 I = 1, NTOK                                                        
        DO 110 J = 1, 4                                                         
          TOKENS(I,J) = FMLPOL(POS)                                             
          POS = POS + 1                                                         
110     CONTINUE                                                                
100   CONTINUE                                                                  
                                                                                
      RETURN                                                                    
                                                                                
C     Not a formula                                                             
900   NTOK = 0                                                                  
      RETURN                                                                    
      END                                                                       
:FILE                                                                           
:QUIT                                                                           
$                                                                               
$ RUN FORTRAN                                                                   
*SOURCE=CELLS.FOR                                                               
*OBJECT=CELLS.OBJ                                                               
*LINK                                                                           
$                                                                               
$ * Create and compile DEPS.FOR                                                 
$ EDIT DEPS.FOR                                                                 
C     DEPS.FOR - Dependency Tracking Module                                     
C                                                                               
C     Purpose: Track which cells depend on other cells                          
C                                                                               
C     Data Structure: Hash table with linked lists                              
C       Hash by source cell (the cell being referenced)                         
C       Each node stores one dependency relationship                            
C       Supports multiple dependents per source cell                            
C                                                                               
C     Example: A3 = +A1+A2                                                      
C       Dependencies stored:                                                    
C         A1 -> [A3]  (A3 depends on A1)                                        
C         A2 -> [A3]  (A3 depends on A2)                                        
C                                                                               
C     Storage:                                                                  
C       DEPNOD(i,1) = Source column                                             
C       DEPNOD(i,2) = Source row                                                
C       DEPNOD(i,3) = Dependent column                                          
C       DEPNOD(i,4) = Dependent row                                             
C       DEPNOD(i,5) = Next pointer (linked list)                                
C                                                                               
C     Configuration:                                                            
C       Array sizes defined by PARAMETER statements in each subroutine.         
C       Default: FULL configuration (for large systems)                         
C       For CP/M: MAXDEP=150, DEPHSZ=64, MAXQUE=75, MAXDPS=50                   
C       For minimal: MAXDEP=50, DEPHSZ=32, MAXQUE=25, MAXDPS=25                 
C                                                                               
C     Dependencies: None (standalone module)                                    
C                                                                               
C     Author: Claude Code                                                       
C     Date: 2026-01-18                                                          
C     Updated: 2026-01-19 (Added configurable array sizes)                      
C                                                                               
C======================================================================         
                                                                                
C======================================================================         
C     DEPSINI - Initialize dependency graph                                     
C======================================================================         
      SUBROUTINE DEPSINI                                                        
C     Configuration parameters                                                  
      INTEGER MAXDEP, DEPHSZ                                                    
      PARAMETER (MAXDEP=1000, DEPHSZ=256)                                       
C                                                                               
      COMMON /DEPDAT/ DEPNOD, DEPHT, DEPFRE                                     
      INTEGER DEPNOD(MAXDEP, 5)                                                 
      INTEGER DEPHT(DEPHSZ)                                                     
      INTEGER DEPFRE                                                            
      INTEGER I                                                                 
                                                                                
C     Clear hash table                                                          
      DO 10 I = 1, DEPHSZ                                                       
        DEPHT(I) = 0                                                            
10    CONTINUE                                                                  
                                                                                
C     Initialize free list                                                      
      DEPFRE = 1                                                                
      DO 20 I = 1, MAXDEP - 1                                                   
        DEPNOD(I,5) = I + 1                                                     
20    CONTINUE                                                                  
      DEPNOD(MAXDEP,5) = 0                                                      
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DEPSADD - Add dependency                                                  
C======================================================================         
      SUBROUTINE DEPSADD(SCOL, SROW, DCOL, DROW)                                
      INTEGER SCOL, SROW, DCOL, DROW                                            
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXDEP, DEPHSZ                                                    
      PARAMETER (MAXDEP=1000, DEPHSZ=256)                                       
C                                                                               
      COMMON /DEPDAT/ DEPNOD, DEPHT, DEPFRE                                     
      INTEGER DEPNOD(MAXDEP, 5)                                                 
      INTEGER DEPHT(DEPHSZ)                                                     
      INTEGER DEPFRE                                                            
                                                                                
      INTEGER HASH, DEPSHSH, NODE                                               
                                                                                
C     Get hash for source cell                                                  
      HASH = DEPSHSH(SCOL, SROW)                                                
                                                                                
C     Check if already exists                                                   
      CALL DEPSFND(SCOL, SROW, DCOL, DROW, NODE)                                
      IF (NODE .NE. 0) RETURN                                                   
                                                                                
C     Allocate new node from free list                                          
      IF (DEPFRE .EQ. 0) RETURN                                                 
      NODE = DEPFRE                                                             
      DEPFRE = DEPNOD(NODE,5)                                                   
                                                                                
C     Fill node                                                                 
      DEPNOD(NODE,1) = SCOL                                                     
      DEPNOD(NODE,2) = SROW                                                     
      DEPNOD(NODE,3) = DCOL                                                     
      DEPNOD(NODE,4) = DROW                                                     
                                                                                
C     Insert at head of hash bucket                                             
      DEPNOD(NODE,5) = DEPHT(HASH)                                              
      DEPHT(HASH) = NODE                                                        
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DEPSDEL - Delete dependency                                               
C======================================================================         
      SUBROUTINE DEPSDEL(SCOL, SROW, DCOL, DROW)                                
      INTEGER SCOL, SROW, DCOL, DROW                                            
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXDEP, DEPHSZ                                                    
      PARAMETER (MAXDEP=1000, DEPHSZ=256)                                       
C                                                                               
      COMMON /DEPDAT/ DEPNOD, DEPHT, DEPFRE                                     
      INTEGER DEPNOD(MAXDEP, 5)                                                 
      INTEGER DEPHT(DEPHSZ)                                                     
      INTEGER DEPFRE                                                            
                                                                                
      INTEGER HASH, DEPSHSH, NODE, PREV, CURR                                   
                                                                                
C     Get hash for source cell                                                  
      HASH = DEPSHSH(SCOL, SROW)                                                
                                                                                
C     Search for node to delete                                                 
      PREV = 0                                                                  
      CURR = DEPHT(HASH)                                                        
                                                                                
100   IF (CURR .EQ. 0) RETURN                                                   
                                                                                
C     Check if this is the node to delete                                       
      IF (DEPNOD(CURR,1) .NE. SCOL) GO TO 110                                   
      IF (DEPNOD(CURR,2) .NE. SROW) GO TO 110                                   
      IF (DEPNOD(CURR,3) .NE. DCOL) GO TO 110                                   
      IF (DEPNOD(CURR,4) .NE. DROW) GO TO 110                                   
                                                                                
C     Found it - remove from list                                               
      IF (PREV .EQ. 0) GO TO 120                                                
      DEPNOD(PREV,5) = DEPNOD(CURR,5)                                           
      GO TO 130                                                                 
                                                                                
120   DEPHT(HASH) = DEPNOD(CURR,5)                                              
                                                                                
C     Return node to free list                                                  
130   DEPNOD(CURR,5) = DEPFRE                                                   
      DEPFRE = CURR                                                             
      RETURN                                                                    
                                                                                
C     Not this node - continue search                                           
110   PREV = CURR                                                               
      CURR = DEPNOD(CURR,5)                                                     
      GO TO 100                                                                 
      END                                                                       
                                                                                
C======================================================================         
C     DEPSGET - Get all dependents of a cell                                    
C======================================================================         
      SUBROUTINE DEPSGET(SCOL, SROW, DEPS, NDEPS)                               
      INTEGER SCOL, SROW                                                        
C     Configuration parameters                                                  
      INTEGER MAXDPS                                                            
      PARAMETER (MAXDPS=100)                                                    
C                                                                               
      INTEGER DEPS(MAXDPS, 2)                                                   
      INTEGER NDEPS                                                             
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXDEP, DEPHSZ                                                    
      PARAMETER (MAXDEP=1000, DEPHSZ=256)                                       
C                                                                               
      COMMON /DEPDAT/ DEPNOD, DEPHT, DEPFRE                                     
      INTEGER DEPNOD(MAXDEP, 5)                                                 
      INTEGER DEPHT(DEPHSZ)                                                     
      INTEGER DEPFRE                                                            
                                                                                
      INTEGER HASH, DEPSHSH, NODE                                               
                                                                                
      NDEPS = 0                                                                 
      HASH = DEPSHSH(SCOL, SROW)                                                
      NODE = DEPHT(HASH)                                                        
                                                                                
C     Scan hash bucket                                                          
100   IF (NODE .EQ. 0) RETURN                                                   
                                                                                
C     Check if source matches                                                   
      IF (DEPNOD(NODE,1) .NE. SCOL) GO TO 110                                   
      IF (DEPNOD(NODE,2) .NE. SROW) GO TO 110                                   
                                                                                
C     Match - add to result                                                     
      NDEPS = NDEPS + 1                                                         
      DEPS(NDEPS,1) = DEPNOD(NODE,3)                                            
      DEPS(NDEPS,2) = DEPNOD(NODE,4)                                            
                                                                                
C     Continue to next node                                                     
110   NODE = DEPNOD(NODE,5)                                                     
      GO TO 100                                                                 
      END                                                                       
                                                                                
C======================================================================         
C     DEPSCIR - Check for circular reference (iterative)                        
C======================================================================         
      SUBROUTINE DEPSCIR(COL, ROW, CIRC)                                        
      INTEGER COL, ROW, CIRC                                                    
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXDEP, DEPHSZ, MAXQUE                                            
      PARAMETER (MAXDEP=1000, DEPHSZ=256, MAXQUE=500)                           
C                                                                               
      COMMON /DEPDAT/ DEPNOD, DEPHT, DEPFRE                                     
      INTEGER DEPNOD(MAXDEP, 5)                                                 
      INTEGER DEPHT(DEPHSZ)                                                     
      INTEGER DEPFRE                                                            
                                                                                
C     Work queue for breadth-first search                                       
      INTEGER QUEUE(MAXQUE, 2)                                                  
      INTEGER QHEAD, QTAIL                                                      
                                                                                
C     Visited set                                                               
      INTEGER VISIT(MAXQUE)                                                     
      INTEGER NVISIT                                                            
                                                                                
C     Working variables                                                         
      INTEGER CCOL, CROW, HASH, DEPSHSH, NODE                                   
      INTEGER DCOL, DROW, I, FOUND                                              
                                                                                
      CIRC = 0                                                                  
      QHEAD = 1                                                                 
      QTAIL = 1                                                                 
      NVISIT = 0                                                                
                                                                                
C     Add starting cell to queue                                                
      QUEUE(QTAIL,1) = COL                                                      
      QUEUE(QTAIL,2) = ROW                                                      
      QTAIL = QTAIL + 1                                                         
                                                                                
C     Process queue                                                             
100   IF (QHEAD .GE. QTAIL) RETURN                                              
                                                                                
C     Get next cell from queue                                                  
      CCOL = QUEUE(QHEAD,1)                                                     
      CROW = QUEUE(QHEAD,2)                                                     
      QHEAD = QHEAD + 1                                                         
                                                                                
C     Check if already visited                                                  
      DO 110 I = 1, NVISIT                                                      
        IF (VISIT(I) .EQ. CCOL * 1000 + CROW) GO TO 100                         
110   CONTINUE                                                                  
                                                                                
C     Mark as visited                                                           
      NVISIT = NVISIT + 1                                                       
      VISIT(NVISIT) = CCOL * 1000 + CROW                                        
                                                                                
C     Get all dependents of this cell                                           
      HASH = DEPSHSH(CCOL, CROW)                                                
      NODE = DEPHT(HASH)                                                        
                                                                                
C     Check each dependent                                                      
200   IF (NODE .EQ. 0) GO TO 100                                                
                                                                                
C     Check if source matches current cell                                      
      IF (DEPNOD(NODE,1) .NE. CCOL) GO TO 210                                   
      IF (DEPNOD(NODE,2) .NE. CROW) GO TO 210                                   
                                                                                
C     Get dependent cell                                                        
      DCOL = DEPNOD(NODE,3)                                                     
      DROW = DEPNOD(NODE,4)                                                     
                                                                                
C     Check if dependent is original target (circular!)                         
      IF (DCOL .NE. COL) GO TO 220                                              
      IF (DROW .NE. ROW) GO TO 220                                              
      CIRC = 1                                                                  
      RETURN                                                                    
                                                                                
C     Add dependent to queue                                                    
220   QUEUE(QTAIL,1) = DCOL                                                     
      QUEUE(QTAIL,2) = DROW                                                     
      QTAIL = QTAIL + 1                                                         
                                                                                
C     Continue to next node                                                     
210   NODE = DEPNOD(NODE,5)                                                     
      GO TO 200                                                                 
      END                                                                       
                                                                                
C======================================================================         
C     DEPSHSH - Hash function for dependency lookup                             
C======================================================================         
      INTEGER FUNCTION DEPSHSH(COL, ROW)                                        
      INTEGER COL, ROW                                                          
                                                                                
C     Configuration parameters                                                  
      INTEGER DEPHSZ                                                            
      PARAMETER (DEPHSZ=256)                                                    
C                                                                               
C     Hash function: (COL * 257 + ROW) MOD DEPHSZ                               
      DEPSHSH = MOD(COL * 257 + ROW, DEPHSZ) + 1                                
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DEPSFND - Find dependency node (internal)                                 
C======================================================================         
      SUBROUTINE DEPSFND(SCOL, SROW, DCOL, DROW, NODE)                          
      INTEGER SCOL, SROW, DCOL, DROW, NODE                                      
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXDEP, DEPHSZ                                                    
      PARAMETER (MAXDEP=1000, DEPHSZ=256)                                       
C                                                                               
      COMMON /DEPDAT/ DEPNOD, DEPHT, DEPFRE                                     
      INTEGER DEPNOD(MAXDEP, 5)                                                 
      INTEGER DEPHT(DEPHSZ)                                                     
      INTEGER DEPFRE                                                            
                                                                                
      INTEGER HASH, DEPSHSH                                                     
                                                                                
      HASH = DEPSHSH(SCOL, SROW)                                                
      NODE = DEPHT(HASH)                                                        
                                                                                
C     Search hash bucket                                                        
100   IF (NODE .EQ. 0) RETURN                                                   
                                                                                
C     Check if matches                                                          
      IF (DEPNOD(NODE,1) .NE. SCOL) GO TO 110                                   
      IF (DEPNOD(NODE,2) .NE. SROW) GO TO 110                                   
      IF (DEPNOD(NODE,3) .NE. DCOL) GO TO 110                                   
      IF (DEPNOD(NODE,4) .NE. DROW) GO TO 110                                   
      RETURN                                                                    
                                                                                
C     Continue search                                                           
110   NODE = DEPNOD(NODE,5)                                                     
      GO TO 100                                                                 
      END                                                                       
:FILE                                                                           
:QUIT                                                                           
$                                                                               
$ RUN FORTRAN                                                                   
*SOURCE=DEPS.FOR                                                                
*OBJECT=DEPS.OBJ                                                                
*LINK                                                                           
$                                                                               
$ * Create and compile PARSE.FOR                                                
$ EDIT PARSE.FOR                                                                
C     PARSE.FOR - Formula Parser Module                                         
C                                                                               
C     Purpose: Parse formulas and convert infix to postfix (RPN)                
C                                                                               
C     Algorithm: Shunting-yard (Dijkstra)                                       
C       Input:  "+A1*2+B2"  (infix formula)                                     
C       Output: A1 2 * B2 + (postfix tokens)                                    
C                                                                               
C     Features:                                                                 
C       - Tokenize numbers, cells, operators, functions                         
C       - Operator precedence: ^ > */ > +- > comparisons                        
C       - Parentheses for grouping                                              
C       - Cell references (A1, B2, etc.)                                        
C       - Functions (@SUM, @AVG, etc.)                                          
C                                                                               
C     Token structure:                                                          
C       TOKENS(i,1) = TYPE (1=number, 2=cell, 3=operator, 4=function)           
C       TOKENS(i,2) = VALUE (number or operator code)                           
C       TOKENS(i,3) = COL (for cells)                                           
C       TOKENS(i,4) = ROW (for cells)                                           
C                                                                               
C     Operator codes:                                                           
C       1 = + (add)                                                             
C       2 = - (subtract)                                                        
C       3 = * (multiply)                                                        
C       4 = / (divide)                                                          
C       5 = ^ (power)                                                           
C                                                                               
C     Configuration:                                                            
C       Array sizes defined by PARAMETER statements.                            
C       Default: MAXTOK=100, MAXSTK=50                                          
C       For CP/M: MAXTOK=50, MAXSTK=25                                          
C       For minimal: MAXTOK=25, MAXSTK=15                                       
C                                                                               
C     Dependencies: STRUTIL.FOR                                                 
C                                                                               
C     Author: Claude Code                                                       
C     Date: 2026-01-18                                                          
C     Updated: 2026-01-19 (Added configurable array sizes)                      
C                                                                               
C======================================================================         
                                                                                
C======================================================================         
C     PRSINI - Initialize parser                                                
C======================================================================         
      SUBROUTINE PRSINI                                                         
C     Nothing to initialize for now                                             
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     PARSE - Parse formula to postfix tokens                                   
C======================================================================         
      SUBROUTINE PARSE(INPUT, INLEN, TOKENS, NTOK, ERROR)                       
      INTEGER INPUT(*), INLEN                                                   
C     Configuration parameters                                                  
      INTEGER MAXTOK, MAXSTK                                                    
      PARAMETER (MAXTOK=100, MAXSTK=50)                                         
C                                                                               
      INTEGER TOKENS(MAXTOK, 4)                                                 
      INTEGER NTOK, ERROR                                                       
                                                                                
C     Operator stack for shunting-yard                                          
      INTEGER OPSTK(MAXSTK)                                                     
      INTEGER OPSTKP                                                            
                                                                                
C     Working variables                                                         
      INTEGER POS, TTYPE, TVAL, TCOL, TROW                                      
      INTEGER TOKNXT, OPPREC                                                    
                                                                                
      NTOK = 0                                                                  
      ERROR = 0                                                                 
      OPSTKP = 0                                                                
      POS = 1                                                                   
                                                                                
C     Skip leading + (formula indicator)                                        
      IF (INPUT(POS) .EQ. 43) POS = POS + 1                                     
                                                                                
C     Process input tokens                                                      
100   IF (POS .GT. INLEN) GO TO 200                                             
                                                                                
C     Get next token                                                            
      TTYPE = TOKNXT(INPUT, INLEN, POS, TVAL, TCOL, TROW)                       
                                                                                
C     End of input                                                              
      IF (TTYPE .EQ. 0) GO TO 200                                               
                                                                                
C     Number or cell - add to output                                            
      IF (TTYPE .EQ. 1 .OR. TTYPE .EQ. 2) GO TO 110                             
                                                                                
C     Operator - process precedence                                             
      IF (TTYPE .EQ. 3) GO TO 120                                               
                                                                                
C     Unknown token type                                                        
      ERROR = 1                                                                 
      RETURN                                                                    
                                                                                
C     Add number or cell to output                                              
110   NTOK = NTOK + 1                                                           
      TOKENS(NTOK,1) = TTYPE                                                    
      TOKENS(NTOK,2) = TVAL                                                     
      TOKENS(NTOK,3) = TCOL                                                     
      TOKENS(NTOK,4) = TROW                                                     
      GO TO 100                                                                 
                                                                                
C     Process operator                                                          
120   CONTINUE                                                                  
                                                                                
C     Pop higher precedence operators from stack                                
130   IF (OPSTKP .LE. 0) GO TO 140                                              
      IF (OPPREC(OPSTK(OPSTKP)) .LT. OPPREC(TVAL)) GO TO 140                    
                                                                                
C     Pop operator to output                                                    
      NTOK = NTOK + 1                                                           
      TOKENS(NTOK,1) = 3                                                        
      TOKENS(NTOK,2) = OPSTK(OPSTKP)                                            
      TOKENS(NTOK,3) = 0                                                        
      TOKENS(NTOK,4) = 0                                                        
      OPSTKP = OPSTKP - 1                                                       
      GO TO 130                                                                 
                                                                                
C     Push current operator to stack                                            
140   OPSTKP = OPSTKP + 1                                                       
      OPSTK(OPSTKP) = TVAL                                                      
      GO TO 100                                                                 
                                                                                
C     Pop remaining operators                                                   
200   IF (OPSTKP .LE. 0) GO TO 300                                              
                                                                                
      NTOK = NTOK + 1                                                           
      TOKENS(NTOK,1) = 3                                                        
      TOKENS(NTOK,2) = OPSTK(OPSTKP)                                            
      TOKENS(NTOK,3) = 0                                                        
      TOKENS(NTOK,4) = 0                                                        
      OPSTKP = OPSTKP - 1                                                       
      GO TO 200                                                                 
                                                                                
300   RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TOKNXT - Get next token from input                                        
C======================================================================         
      INTEGER FUNCTION TOKNXT(INPUT, INLEN, POS, TVAL, TCOL, TROW)              
      INTEGER INPUT(*), INLEN, POS                                              
      INTEGER TVAL, TCOL, TROW                                                  
                                                                                
      INTEGER CH, I, NUM                                                        
                                                                                
C     Skip whitespace                                                           
100   IF (POS .GT. INLEN) GO TO 900                                             
      CH = INPUT(POS)                                                           
      IF (CH .EQ. 32) GO TO 110                                                 
      GO TO 200                                                                 
                                                                                
110   POS = POS + 1                                                             
      GO TO 100                                                                 
                                                                                
C     Check token type                                                          
200   CH = INPUT(POS)                                                           
                                                                                
C     Check for number (digit)                                                  
      IF (CH .GE. 48 .AND. CH .LE. 57) GO TO 300                                
                                                                                
C     Check for cell (letter)                                                   
      IF (CH .GE. 65 .AND. CH .LE. 90) GO TO 400                                
                                                                                
C     Check for operator                                                        
      IF (CH .EQ. 43) GO TO 510  ! +                                            
      IF (CH .EQ. 45) GO TO 520  ! -                                            
      IF (CH .EQ. 42) GO TO 530  ! *                                            
      IF (CH .EQ. 47) GO TO 540  ! /                                            
      IF (CH .EQ. 94) GO TO 550  ! ^                                            
                                                                                
C     Unknown                                                                   
      GO TO 900                                                                 
                                                                                
C     Parse number                                                              
300   NUM = 0                                                                   
310   IF (POS .GT. INLEN) GO TO 320                                             
      CH = INPUT(POS)                                                           
      IF (CH .LT. 48 .OR. CH .GT. 57) GO TO 320                                 
      NUM = NUM * 10 + (CH - 48)                                                
      POS = POS + 1                                                             
      GO TO 310                                                                 
                                                                                
320   TOKNXT = 1          ! TYPE=number                                         
      TVAL = NUM                                                                
      TCOL = 0                                                                  
      TROW = 0                                                                  
      RETURN                                                                    
                                                                                
C     Parse cell reference (e.g., A1, B23)                                      
400   CONTINUE                                                                  
                                                                                
C     Get column (A-Z)                                                          
      CH = INPUT(POS)                                                           
      TCOL = CH - 64      ! A=1, B=2, etc.                                      
      POS = POS + 1                                                             
                                                                                
C     Get row number                                                            
      TROW = 0                                                                  
410   IF (POS .GT. INLEN) GO TO 420                                             
      CH = INPUT(POS)                                                           
      IF (CH .LT. 48 .OR. CH .GT. 57) GO TO 420                                 
      TROW = TROW * 10 + (CH - 48)                                              
      POS = POS + 1                                                             
      GO TO 410                                                                 
                                                                                
420   TOKNXT = 2          ! TYPE=cell                                           
      TVAL = 0                                                                  
      RETURN                                                                    
                                                                                
C     Operators                                                                 
510   POS = POS + 1                                                             
      TOKNXT = 3          ! TYPE=operator                                       
      TVAL = 1            ! OP_ADD                                              
      TCOL = 0                                                                  
      TROW = 0                                                                  
      RETURN                                                                    
                                                                                
520   POS = POS + 1                                                             
      TOKNXT = 3                                                                
      TVAL = 2            ! OP_SUB                                              
      TCOL = 0                                                                  
      TROW = 0                                                                  
      RETURN                                                                    
                                                                                
530   POS = POS + 1                                                             
      TOKNXT = 3                                                                
      TVAL = 3            ! OP_MUL                                              
      TCOL = 0                                                                  
      TROW = 0                                                                  
      RETURN                                                                    
                                                                                
540   POS = POS + 1                                                             
      TOKNXT = 3                                                                
      TVAL = 4            ! OP_DIV                                              
      TCOL = 0                                                                  
      TROW = 0                                                                  
      RETURN                                                                    
                                                                                
550   POS = POS + 1                                                             
      TOKNXT = 3                                                                
      TVAL = 5            ! OP_POW                                              
      TCOL = 0                                                                  
      TROW = 0                                                                  
      RETURN                                                                    
                                                                                
C     End of input or error                                                     
900   TOKNXT = 0                                                                
      TVAL = 0                                                                  
      TCOL = 0                                                                  
      TROW = 0                                                                  
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     OPPREC - Get operator precedence                                          
C======================================================================         
      INTEGER FUNCTION OPPREC(OP)                                               
      INTEGER OP                                                                
                                                                                
C     Precedence levels (higher = tighter binding):                             
C       3 = ^ (power)                                                           
C       2 = * / (multiply, divide)                                              
C       1 = + - (add, subtract)                                                 
                                                                                
      IF (OP .EQ. 5) GO TO 100  ! ^                                             
      IF (OP .EQ. 3) GO TO 200  ! *                                             
      IF (OP .EQ. 4) GO TO 200  ! /                                             
      IF (OP .EQ. 1) GO TO 300  ! +                                             
      IF (OP .EQ. 2) GO TO 300  ! -                                             
                                                                                
C     Default                                                                   
      OPPREC = 0                                                                
      RETURN                                                                    
                                                                                
100   OPPREC = 3                                                                
      RETURN                                                                    
                                                                                
200   OPPREC = 2                                                                
      RETURN                                                                    
                                                                                
300   OPPREC = 1                                                                
      RETURN                                                                    
      END                                                                       
:FILE                                                                           
:QUIT                                                                           
$                                                                               
$ RUN FORTRAN                                                                   
*SOURCE=PARSE.FOR                                                               
*OBJECT=PARSE.OBJ                                                               
*LINK                                                                           
$                                                                               
$ * Create and compile EVAL.FOR                                                 
$ EDIT EVAL.FOR                                                                 
C     EVAL.FOR - Expression Evaluator Module                                    
C                                                                               
C     Purpose: Evaluate postfix expressions from parser                         
C                                                                               
C     Algorithm: Stack-based postfix evaluation                                 
C       Input:  Tokens from PARSE (postfix/RPN)                                 
C       Process: Push operands, pop for operators, push result                  
C       Output: Calculated result                                               
C                                                                               
C     Example:                                                                  
C       Tokens: 10 20 +                                                         
C       Stack:  [] -> [10] -> [10,20] -> [30]                                   
C       Result: 30                                                              
C                                                                               
C     Features:                                                                 
C       - Stack-based evaluation (no recursion)                                 
C       - Get cell values from CELLS module                                     
C       - Handle all operators (+, -, *, /, ^)                                  
C       - Error handling (division by zero, etc.)                               
C                                                                               
C     Configuration:                                                            
C       Array sizes defined by PARAMETER statements.                            
C       Default: MAXTOK=100, MAXSTK=50                                          
C       For CP/M: MAXTOK=50, MAXSTK=25                                          
C       For minimal: MAXTOK=25, MAXSTK=15                                       
C                                                                               
C     Dependencies: STRUTIL.FOR, CELLS.FOR                                      
C                                                                               
C     Author: Claude Code                                                       
C     Date: 2026-01-18                                                          
C     Updated: 2026-01-19 (Added configurable array sizes)                      
C                                                                               
C======================================================================         
                                                                                
C======================================================================         
C     EVLINI - Initialize evaluator                                             
C======================================================================         
      SUBROUTINE EVLINI                                                         
C     Nothing to initialize for now                                             
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     EVAL - Evaluate postfix expression                                        
C======================================================================         
      SUBROUTINE EVAL(TOKENS, NTOK, RESULT, ERROR)                              
C     Configuration parameters                                                  
      INTEGER MAXTOK, MAXSTK                                                    
      PARAMETER (MAXTOK=100, MAXSTK=50)                                         
C                                                                               
      INTEGER TOKENS(MAXTOK, 4), NTOK, ERROR                                    
      REAL RESULT                                                               
                                                                                
C     Evaluation stack                                                          
      REAL EVSTK(MAXSTK)                                                        
      INTEGER EVSTKP                                                            
                                                                                
C     Working variables                                                         
      INTEGER I, TTYPE, TVAL, TCOL, TROW                                        
      REAL VAL, OP1, OP2, TRES                                                  
      INTEGER CTYPE                                                             
                                                                                
      ERROR = 0                                                                 
      EVSTKP = 0                                                                
                                                                                
C     Process tokens left to right                                              
      DO 100 I = 1, NTOK                                                        
        TTYPE = TOKENS(I,1)                                                     
        TVAL = TOKENS(I,2)                                                      
        TCOL = TOKENS(I,3)                                                      
        TROW = TOKENS(I,4)                                                      
                                                                                
C       Number - push value                                                     
        IF (TTYPE .EQ. 1) GO TO 20                                              
                                                                                
C       Cell - get value and push                                               
        IF (TTYPE .EQ. 2) GO TO 30                                              
                                                                                
C       Operator - pop, calculate, push                                         
        IF (TTYPE .EQ. 3) GO TO 40                                              
                                                                                
C       Unknown type                                                            
        ERROR = 1                                                               
        RETURN                                                                  
                                                                                
C       Push number value                                                       
20      VAL = REAL(TVAL)                                                        
        CALL EVPUSH(VAL, EVSTK, EVSTKP)                                         
        GO TO 100                                                               
                                                                                
C       Get cell value and push                                                 
30      CALL CELGET(TCOL, TROW, CTYPE, VAL)                                     
C       If cell empty, treat as 0                                               
        IF (CTYPE .EQ. 0) VAL = 0.0                                             
        CALL EVPUSH(VAL, EVSTK, EVSTKP)                                         
        GO TO 100                                                               
                                                                                
C       Process operator                                                        
40      CONTINUE                                                                
                                                                                
C       Pop two operands                                                        
        IF (EVSTKP .LT. 2) GO TO 900                                            
        CALL EVPOP(OP2, EVSTK, EVSTKP)                                          
        CALL EVPOP(OP1, EVSTK, EVSTKP)                                          
                                                                                
C       Calculate based on operator                                             
        IF (TVAL .EQ. 1) TRES = OP1 + OP2     ! +                               
        IF (TVAL .EQ. 2) TRES = OP1 - OP2     ! -                               
        IF (TVAL .EQ. 3) TRES = OP1 * OP2     ! *                               
        IF (TVAL .EQ. 4) TRES = OP1 / OP2     ! /                               
        IF (TVAL .EQ. 5) TRES = OP1 ** OP2    ! ^                               
                                                                                
C       Push result                                                             
        CALL EVPUSH(TRES, EVSTK, EVSTKP)                                        
                                                                                
100   CONTINUE                                                                  
                                                                                
C     Final result is top of stack                                              
      IF (EVSTKP .NE. 1) GO TO 900                                              
      CALL EVPOP(RESULT, EVSTK, EVSTKP)                                         
      RETURN                                                                    
                                                                                
C     Error: stack underflow or incorrect final stack size                      
900   ERROR = 1                                                                 
      RESULT = 0.0                                                              
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     EVPUSH - Push value to evaluation stack                                   
C======================================================================         
      SUBROUTINE EVPUSH(VAL, EVSTK, EVSTKP)                                     
      REAL VAL, EVSTK(*)                                                        
      INTEGER EVSTKP                                                            
                                                                                
      EVSTKP = EVSTKP + 1                                                       
      EVSTK(EVSTKP) = VAL                                                       
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     EVPOP - Pop value from evaluation stack                                   
C======================================================================         
      SUBROUTINE EVPOP(VAL, EVSTK, EVSTKP)                                      
      REAL VAL, EVSTK(*)                                                        
      INTEGER EVSTKP                                                            
                                                                                
      VAL = EVSTK(EVSTKP)                                                       
      EVSTKP = EVSTKP - 1                                                       
                                                                                
      RETURN                                                                    
      END                                                                       
:FILE                                                                           
:QUIT                                                                           
$                                                                               
$ RUN FORTRAN                                                                   
*SOURCE=EVAL.FOR                                                                
*OBJECT=EVAL.OBJ                                                                
*LINK                                                                           
$                                                                               
$ * Create and compile RECALC.FOR                                               
$ EDIT RECALC.FOR                                                               
C     RECALC.FOR - Recalculation Engine Module                                  
C                                                                               
C     Purpose: Propagate changes through dependency graph                       
C                                                                               
C     Algorithm: Breadth-first propagation                                      
C       - Get formula tokens from cell                                          
C       - Evaluate formula                                                      
C       - Store result                                                          
C       - Get dependents                                                        
C       - Add dependents to queue                                               
C       - Process queue until empty                                             
C                                                                               
C     Features:                                                                 
C       - Recalculate single cell                                               
C       - Propagate to all dependents                                           
C       - Iterative (no recursion)                                              
C       - Handles circular references                                           
C                                                                               
C     Configuration:                                                            
C       Array sizes defined by PARAMETER statements.                            
C       Default: MAXQUE=500, MAXTOK=100, MAXDPS=100                             
C       For CP/M: MAXQUE=75, MAXTOK=50, MAXDPS=50                               
C       For minimal: MAXQUE=25, MAXTOK=25, MAXDPS=25                            
C                                                                               
C     Dependencies: CELLS.FOR, PARSE.FOR, EVAL.FOR, DEPS.FOR                    
C                                                                               
C     Author: Claude Code                                                       
C     Date: 2026-01-19                                                          
C     Updated: 2026-01-19 (Added configurable array sizes)                      
C                                                                               
C======================================================================         
                                                                                
C======================================================================         
C     RECINI - Initialize recalculation engine                                  
C======================================================================         
      SUBROUTINE RECINI                                                         
C     Nothing to initialize for now                                             
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     RECCEL - Recalculate cell and propagate to dependents                     
C======================================================================         
      SUBROUTINE RECCEL(COL, ROW)                                               
      INTEGER COL, ROW                                                          
                                                                                
C     Configuration parameters                                                  
      INTEGER MAXQUE, MAXTOK, MAXDPS                                            
      PARAMETER (MAXQUE=500, MAXTOK=100, MAXDPS=100)                            
C                                                                               
C     Work queue for propagation                                                
      INTEGER QUEUE(MAXQUE, 2)                                                  
      INTEGER QHEAD, QTAIL                                                      
                                                                                
C     Working variables                                                         
      INTEGER CCOL, CROW                                                        
      INTEGER TOKENS(MAXTOK, 4), NTOK, ERROR                                    
      REAL RESULT                                                               
      INTEGER CTYPE                                                             
      REAL VAL                                                                  
      INTEGER DEPS(MAXDPS, 2), NDEPS                                            
      INTEGER I                                                                 
                                                                                
C     Initialize queue                                                          
      QHEAD = 1                                                                 
      QTAIL = 1                                                                 
                                                                                
C     Add starting cell to queue                                                
      QUEUE(QTAIL,1) = COL                                                      
      QUEUE(QTAIL,2) = ROW                                                      
      QTAIL = QTAIL + 1                                                         
                                                                                
C     Process queue                                                             
100   IF (QHEAD .GE. QTAIL) RETURN                                              
                                                                                
C     Get next cell from queue                                                  
      CCOL = QUEUE(QHEAD,1)                                                     
      CROW = QUEUE(QHEAD,2)                                                     
      QHEAD = QHEAD + 1                                                         
                                                                                
C     Get cell type to see if it's a formula                                    
      CALL CELGET(CCOL, CROW, CTYPE, VAL)                                       
                                                                                
C     If it's a formula, recalculate it                                         
      IF (CTYPE .NE. 2) GO TO 200                                               
                                                                                
C     Get formula tokens                                                        
      CALL CELGTK(CCOL, CROW, TOKENS, NTOK)                                     
      IF (NTOK .EQ. 0) GO TO 200                                                
                                                                                
C     Evaluate formula                                                          
      CALL EVAL(TOKENS, NTOK, RESULT, ERROR)                                    
      IF (ERROR .NE. 0) GO TO 200                                               
                                                                                
C     Store result (use CELRES to keep formula type)                            
      CALL CELRES(CCOL, CROW, RESULT)                                           
                                                                                
C     Get dependents of this cell                                               
200   CALL DEPSGET(CCOL, CROW, DEPS, NDEPS)                                     
                                                                                
C     Add dependents to queue                                                   
      DO 300 I = 1, NDEPS                                                       
        QUEUE(QTAIL,1) = DEPS(I,1)                                              
        QUEUE(QTAIL,2) = DEPS(I,2)                                              
        QTAIL = QTAIL + 1                                                       
300   CONTINUE                                                                  
                                                                                
C     Continue processing queue                                                 
      GO TO 100                                                                 
      END                                                                       
                                                                                
C======================================================================         
C     RECMOD - Set recalculation mode (STUB for future)                         
C======================================================================         
      SUBROUTINE RECMOD(MODE)                                                   
      INTEGER MODE                                                              
                                                                                
C     TODO: Implement auto/manual modes                                         
C     0 = manual                                                                
C     1 = automatic                                                             
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     RECALL - Recalculate all cells (STUB for future)                          
C======================================================================         
      SUBROUTINE RECALL                                                         
                                                                                
C     TODO: Implement full spreadsheet recalc                                   
C     - Get all formula cells                                                   
C     - Topological sort                                                        
C     - Calculate in order                                                      
                                                                                
      RETURN                                                                    
      END                                                                       
:FILE                                                                           
:QUIT                                                                           
$                                                                               
$ RUN FORTRAN                                                                   
*SOURCE=RECALC.FOR                                                              
*OBJECT=RECALC.OBJ                                                              
*LINK                                                                           
$                                                                               
$ * Create and compile UI.FOR                                                   
$ EDIT UI.FOR                                                                   
C     UI.FOR - User Interface State Machine Module                              
C                                                                               
C     Purpose: Manage application modes and user input                          
C                                                                               
C     Modes:                                                                    
C       1 = NAV (navigation) - Moving cursor with arrow keys                    
C       2 = ENTRY (data entry) - Typing formula or value                        
C       3 = POINT (point mode) - Selecting cells for formula                    
C       4 = COMMAND (command mode) - Executing slash commands                   
C                                                                               
C     State:                                                                    
C       Current mode                                                            
C       Cursor position (column, row)                                           
C       Input buffer (for ENTRY mode)                                           
C       Formula being built (for POINT mode)                                    
C                                                                               
C     Mode Transitions:                                                         
C       NAV -> ENTRY: User types printable character or '+'                     
C       NAV -> COMMAND: User types '/'                                          
C       ENTRY -> NAV: User presses ESC or RETURN                                
C       ENTRY -> POINT: User types '.' in formula                               
C       POINT -> ENTRY: User types '.' to anchor cell                           
C       COMMAND -> NAV: User presses ESC or RETURN                              
C                                                                               
C     Dependencies: STRUTIL.FOR, MSG.FOR                                        
C                                                                               
C     Author: Claude Code                                                       
C     Date: 2026-01-19                                                          
C                                                                               
C======================================================================         
                                                                                
C======================================================================         
C     UIINI - Initialize UI system                                              
C======================================================================         
      SUBROUTINE UIINI                                                          
C     UI state                                                                  
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
                                                                                
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
      INTEGER I                                                                 
                                                                                
C     Initialize to NAV mode at cell A1                                         
      CUMODE = 1                                                                
      UICOL = 1                                                                 
      UIROW = 1                                                                 
                                                                                
C     Clear input buffer                                                        
      UIBLEN = 0                                                                
      DO 10 I = 1, 80                                                           
        INBUF(I) = 32                                                           
10    CONTINUE                                                                  
                                                                                
C     Clear formula buffer                                                      
      UIFLEN = 0                                                                
      DO 20 I = 1, 80                                                           
        UIFRM(I) = 32                                                           
20    CONTINUE                                                                  
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     UIGET - Get current UI state                                              
C======================================================================         
      SUBROUTINE UIGET(MODE, COL, ROW)                                          
      INTEGER MODE, COL, ROW                                                    
                                                                                
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
                                                                                
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
      MODE = CUMODE                                                             
      COL = UICOL                                                               
      ROW = UIROW                                                               
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     UIMODE - Set current mode                                                 
C======================================================================         
      SUBROUTINE UIMODE(MODE)                                                   
      INTEGER MODE                                                              
                                                                                
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
                                                                                
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
C     Set mode                                                                  
      CUMODE = MODE                                                             
                                                                                
C     Clear input buffer when entering ENTRY mode                               
      IF (MODE .EQ. 2) UIBLEN = 0                                               
                                                                                
C     Clear formula buffer when entering POINT mode                             
      IF (MODE .EQ. 3) UIFLEN = 0                                               
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     UIMOVE - Move cursor position                                             
C======================================================================         
      SUBROUTINE UIMOVE(COL, ROW)                                               
      INTEGER COL, ROW                                                          
                                                                                
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
                                                                                
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
C     Bounds checking                                                           
      IF (COL .LT. 1) COL = 1                                                   
      IF (COL .GT. 26) COL = 26                                                 
      IF (ROW .LT. 1) ROW = 1                                                   
      IF (ROW .GT. 254) ROW = 254                                               
                                                                                
C     Set position                                                              
      UICOL = COL                                                               
      UIROW = ROW                                                               
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     UIBUF - Input buffer operations                                           
C======================================================================         
      SUBROUTINE UIBUF(OP, CHAR)                                                
      INTEGER OP, CHAR                                                          
                                                                                
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
                                                                                
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
C     Operations:                                                               
C       1 = Add character                                                       
C       2 = Backspace (delete last)                                             
C       3 = Clear buffer                                                        
                                                                                
      IF (OP .EQ. 1) GO TO 100                                                  
      IF (OP .EQ. 2) GO TO 200                                                  
      IF (OP .EQ. 3) GO TO 300                                                  
      RETURN                                                                    
                                                                                
C     Add character                                                             
100   IF (UIBLEN .GE. 80) RETURN                                                
      UIBLEN = UIBLEN + 1                                                       
      INBUF(UIBLEN) = CHAR                                                      
      RETURN                                                                    
                                                                                
C     Backspace                                                                 
200   IF (UIBLEN .LE. 0) RETURN                                                 
      UIBLEN = UIBLEN - 1                                                       
      RETURN                                                                    
                                                                                
C     Clear buffer                                                              
300   UIBLEN = 0                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     UIGETB - Get input buffer                                                 
C======================================================================         
      SUBROUTINE UIGETB(BUF, BLEN)                                              
      INTEGER BUF(80), BLEN                                                     
                                                                                
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
                                                                                
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
      INTEGER I                                                                 
                                                                                
      BLEN = UIBLEN                                                             
                                                                                
      DO 10 I = 1, BLEN                                                         
        BUF(I) = INBUF(I)                                                       
10    CONTINUE                                                                  
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     UIKEY - Process keystroke (STUB for future)                               
C======================================================================         
      SUBROUTINE UIKEY(KEY, ACTION)                                             
      INTEGER KEY, ACTION                                                       
                                                                                
C     TODO: Implement keyboard event handling                                   
C     KEY = ASCII code or special key code                                      
C     ACTION = what to do (move cursor, add to buffer, etc.)                    
                                                                                
C     For now, just return                                                      
      ACTION = 0                                                                
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     UINAV - Handle navigation key (STUB for future)                           
C======================================================================         
      SUBROUTINE UINAV(KEY, NCOL, NROW)                                         
      INTEGER KEY, NCOL, NROW                                                   
                                                                                
C     TODO: Implement navigation (arrow keys, PgUp/Dn, Home/End)                
C     Returns new position in NCOL, NROW                                        
                                                                                
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
                                                                                
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
C     For now, just return current position                                     
      NCOL = UICOL                                                              
      NROW = UIROW                                                              
                                                                                
      RETURN                                                                    
      END                                                                       
:FILE                                                                           
:QUIT                                                                           
$                                                                               
$ RUN FORTRAN                                                                   
*SOURCE=UI.FOR                                                                  
*OBJECT=UI.OBJ                                                                  
*LINK                                                                           
$                                                                               
$ * Create and compile DISPLAY.FOR                                              
$ EDIT DISPLAY.FOR                                                              
C     DISPLAY.FOR - Screen Rendering Module                                     
C                                                                               
C     Purpose: Render spreadsheet grid to terminal                              
C                                                                               
C     Features:                                                                 
C       - Clear screen and draw border                                          
C       - Render spreadsheet grid (208 viewport)                              
C       - Show cell values and formulas                                         
C       - Status line (position, mode, indicators)                              
C       - Edit line for formula entry                                           
C       - Cursor positioning                                                    
C                                                                               
C     Display Layout (24-line VT-52 terminal):                                  
C       Row 1: Status line (position, mode)                                     
C       Row 2: Column headers (A B C D E F G H)                                 
C       Row 3: Separator line                                                   
C       Rows 4-23: Grid (20 rows  8 cols visible)                             
C       Row 24: Edit line                                                       
C                                                                               
C     Viewport:                                                                 
C       Shows 20 rows and 8 columns at a time                                   
C       Scrolls to follow cursor                                                
C                                                                               
C     Dependencies: STRUTIL.FOR, MSG.FOR, UI.FOR, CELLS.FOR, TERMCPV.FOR        
C                                                                               
C     Author: Claude Code                                                       
C     Date: 2026-01-19                                                          
C                                                                               
C======================================================================         
                                                                                
C======================================================================         
C     DSPINI - Initialize display system                                        
C======================================================================         
      SUBROUTINE DSPINI                                                         
C     Initialize display state and clear screen                                 
                                                                                
C     Display state                                                             
      INTEGER DSPTOP, DSPLFT                                                    
      INTEGER DSPMOD                                                            
                                                                                
      COMMON /DSPDAT/ DSPTOP, DSPLFT, DSPMOD                                    
                                                                                
C     Initialize viewport to show row 1, column A                               
      DSPTOP = 1                                                                
      DSPLFT = 1                                                                
                                                                                
C     No special display mode                                                   
      DSPMOD = 0                                                                
                                                                                
C     Initialize terminal                                                       
      CALL TMINIT                                                               
                                                                                
C     Clear screen                                                              
      CALL TMCLR                                                                
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DSPFUL - Full screen redraw                                               
C======================================================================         
      SUBROUTINE DSPFUL                                                         
C     Redraw entire screen                                                      
C     Called after major changes or mode switches                               
                                                                                
C     Clear screen                                                              
      CALL TMCLR                                                                
                                                                                
C     Draw all components                                                       
      CALL DSPSTS                                                               
      CALL DSPHDR                                                               
      CALL DSPSEP                                                               
      CALL DSPGRD                                                               
      CALL DSPEDT                                                               
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DSPHDR - Draw column headers                                              
C======================================================================         
      SUBROUTINE DSPHDR                                                         
C     Draw column headers (A B C D E F G H)                                     
C     Row 2 of display                                                          
                                                                                
C     Display state                                                             
      INTEGER DSPTOP, DSPLFT                                                    
      INTEGER DSPMOD                                                            
      COMMON /DSPDAT/ DSPTOP, DSPLFT, DSPMOD                                    
                                                                                
      INTEGER I, COL                                                            
      INTEGER CNAME(10)                                                         
      INTEGER CLEN                                                              
                                                                                
C     Position at row 2, column 1                                               
      CALL TMCURS(2, 1)                                                         
                                                                                
C     Write "   " (row number space)                                            
      CALL TMPUTS(32, 3)                                                        
                                                                                
C     Draw 8 column headers                                                     
      DO 10 I = 1, 8                                                            
        COL = DSPLFT + I - 1                                                    
                                                                                
C       Convert column number to letter(s)                                      
        CALL COLTOA(COL, CNAME, 10, CLEN)                                       
                                                                                
C       Write column name centered in 10-char width                             
        CALL TMPUTS(32, 4)                                                      
        CALL TMPUTS(CNAME, CLEN)                                                
        CALL TMPUTS(32, 4 - CLEN)                                               
10    CONTINUE                                                                  
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DSPSEP - Draw separator line                                              
C======================================================================         
      SUBROUTINE DSPSEP                                                         
C     Draw separator line under column headers                                  
C     Row 3 of display                                                          
                                                                                
C     Position at row 3, column 1                                               
      CALL TMCURS(3, 1)                                                         
                                                                                
C     Draw line across screen (80 chars)                                        
      CALL TMLINE(80)                                                           
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DSPGRD - Draw spreadsheet grid                                            
C======================================================================         
      SUBROUTINE DSPGRD                                                         
C     Draw spreadsheet grid with cell values                                    
C     Rows 4-23 (20 visible rows)                                               
                                                                                
C     Display state                                                             
      INTEGER DSPTOP, DSPLFT                                                    
      INTEGER DSPMOD                                                            
      COMMON /DSPDAT/ DSPTOP, DSPLFT, DSPMOD                                    
                                                                                
C     UI state (for cursor position)                                            
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
      INTEGER DROW, ROW, COL                                                    
      INTEGER I, SROW                                                           
                                                                                
C     Draw 20 rows                                                              
      DO 20 DROW = 1, 20                                                        
C       Actual row number                                                       
        ROW = DSPTOP + DROW - 1                                                 
                                                                                
C       Screen row (4-23)                                                       
        SROW = DROW + 3                                                         
                                                                                
C       Position at start of row                                                
        CALL TMCURS(SROW, 1)                                                    
                                                                                
C       Draw row number (right-aligned in 3 chars)                              
        IF (ROW .LT. 10) THEN                                                   
          CALL TMPUTS(32, 2)                                                    
          CALL TMPUTN(ROW)                                                      
        ELSE IF (ROW .LT. 100) THEN                                             
          CALL TMPUTS(32, 1)                                                    
          CALL TMPUTN(ROW)                                                      
        ELSE                                                                    
          CALL TMPUTN(ROW)                                                      
        END IF                                                                  
                                                                                
C       Draw cells in this row (8 columns)                                      
        DO 10 I = 1, 8                                                          
          COL = DSPLFT + I - 1                                                  
                                                                                
C         Draw one cell                                                         
          CALL DSPCLL(COL, ROW, UICOL, UIROW)                                   
                                                                                
10      CONTINUE                                                                
                                                                                
20    CONTINUE                                                                  
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DSPCLL - Draw single cell                                                 
C======================================================================         
      SUBROUTINE DSPCLL(COL, ROW, CURCOL, CURROW)                               
      INTEGER COL, ROW                                                          
      INTEGER CURCOL, CURROW                                                    
C     Draw single cell at COL, ROW                                              
C     Highlight if this is current cursor position                              
C     10 characters wide per cell                                               
                                                                                
      INTEGER CTYPE, CVAL(80), CLEN                                             
      REAL VALUE                                                                
      INTEGER I                                                                 
                                                                                
C     Retrieve cell contents                                                    
      CALL CELGET(COL, ROW, CTYPE, VALUE)                                       
                                                                                
C     Get cell formula if it has one                                            
      CALL CELGTK(COL, ROW, CVAL, 80, CLEN)                                     
                                                                                
C     Check if this is cursor position                                          
C     (For now, no highlighting since VT-52 doesn't support it)                 
                                                                                
C     Draw cell border                                                          
      CALL TMPUTC(32)                                                           
                                                                                
C     Draw cell contents                                                        
      IF (CTYPE .EQ. 0) THEN                                                    
C       Empty cell - fill with spaces                                           
        DO 10 I = 1, 9                                                          
          CALL TMPUTC(32)                                                       
10      CONTINUE                                                                
                                                                                
      ELSE IF (CTYPE .EQ. 1) THEN                                               
C       Numeric value - right-align                                             
        CALL TMPUTR(VALUE, 2)                                                   
                                                                                
C       Pad remaining space                                                     
        DO 20 I = 1, 2                                                          
          CALL TMPUTC(32)                                                       
20      CONTINUE                                                                
                                                                                
      ELSE IF (CTYPE .EQ. 2) THEN                                               
C       Formula - show result right-aligned                                     
        CALL TMPUTR(VALUE, 2)                                                   
                                                                                
C       Pad                                                                     
        DO 30 I = 1, 2                                                          
          CALL TMPUTC(32)                                                       
30      CONTINUE                                                                
                                                                                
      ELSE                                                                      
C       Unknown type - show spaces                                              
        DO 40 I = 1, 9                                                          
          CALL TMPUTC(32)                                                       
40      CONTINUE                                                                
                                                                                
      END IF                                                                    
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DSPSTS - Update status line                                               
C======================================================================         
      SUBROUTINE DSPSTS                                                         
C     Update status line with position and mode                                 
C     Row 1 of display                                                          
                                                                                
C     UI state                                                                  
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
      INTEGER CELRF(10), CLEN                                                   
      INTEGER MNAME(10), MLEN                                                   
      INTEGER I                                                                 
                                                                                
C     Position at row 1, column 1                                               
      CALL TMCURS(1, 1)                                                         
                                                                                
C     Format cell reference (e.g., "A1")                                        
      CALL FMTCEL(UICOL, UIROW, CELRF, 10, CLEN)                                
                                                                                
C     Write cell reference                                                      
      CALL TMPUTS(CELRF, CLEN)                                                  
                                                                                
C     Write separator                                                           
      CALL TMPUTS(32, 2)                                                        
                                                                                
C     Write mode                                                                
      IF (CUMODE .EQ. 1) THEN                                                   
C       NAV mode                                                                
        DATA MNAME /78,65,86,32,32,32,32,32,32,32/                              
        MLEN = 3                                                                
      ELSE IF (CUMODE .EQ. 2) THEN                                              
C       ENTRY mode                                                              
        DATA MNAME /69,78,84,82,89,32,32,32,32,32/                              
        MLEN = 5                                                                
      ELSE IF (CUMODE .EQ. 3) THEN                                              
C       POINT mode                                                              
        DATA MNAME /80,79,73,78,84,32,32,32,32,32/                              
        MLEN = 5                                                                
      ELSE IF (CUMODE .EQ. 4) THEN                                              
C       COMMAND mode                                                            
        DATA MNAME /67,79,77,77,65,78,68,32,32,32/                              
        MLEN = 7                                                                
      ELSE                                                                      
C       Unknown                                                                 
        DATA MNAME /63,63,63,32,32,32,32,32,32,32/                              
        MLEN = 3                                                                
      END IF                                                                    
                                                                                
      CALL TMPUTS(MNAME, MLEN)                                                  
                                                                                
C     Clear rest of status line                                                 
      CALL TMCEOL                                                               
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DSPEDT - Show edit line                                                   
C======================================================================         
      SUBROUTINE DSPEDT                                                         
C     Show edit line with formula                                               
C     Row 24 (bottom of screen)                                                 
                                                                                
C     UI state                                                                  
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
C     Position at row 24, column 1                                              
      CALL TMCURS(24, 1)                                                        
                                                                                
C     Check mode                                                                
      IF (CUMODE .EQ. 2 .OR. CUMODE .EQ. 3) THEN                                
C       ENTRY or POINT mode - show input buffer                                 
                                                                                
        IF (UIBLEN .GT. 0) THEN                                                 
C         Show buffer contents                                                  
          CALL TMPUTS(INBUF, UIBLEN)                                            
        END IF                                                                  
                                                                                
      ELSE IF (CUMODE .EQ. 4) THEN                                              
C       COMMAND mode - show buffer with '/' prefix                              
                                                                                
        CALL TMPUTC(47)                                                         
                                                                                
        IF (UIBLEN .GT. 0) THEN                                                 
          CALL TMPUTS(INBUF, UIBLEN)                                            
        END IF                                                                  
                                                                                
      END IF                                                                    
                                                                                
C     Clear rest of edit line                                                   
      CALL TMCEOL                                                               
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DSPCUR - Position cursor                                                  
C======================================================================         
      SUBROUTINE DSPCUR(ROW, COL)                                               
      INTEGER ROW, COL                                                          
C     Position cursor at grid cell (not screen row/col)                         
C     Converts grid position to screen position                                 
                                                                                
C     Display state                                                             
      INTEGER DSPTOP, DSPLFT                                                    
      INTEGER DSPMOD                                                            
      COMMON /DSPDAT/ DSPTOP, DSPLFT, DSPMOD                                    
                                                                                
      INTEGER SROW, SCOL                                                        
                                                                                
C     Calculate screen row (rows 4-23 for grid)                                 
      SROW = (ROW - DSPTOP) + 4                                                 
                                                                                
C     Calculate screen column                                                   
C     Each cell is 10 chars wide, plus 3 for row number                         
      SCOL = (COL - DSPLFT) * 10 + 4                                            
                                                                                
C     Position cursor                                                           
      CALL TMCURS(SROW, SCOL)                                                   
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DSPSCR - Scroll viewport                                                  
C======================================================================         
      SUBROUTINE DSPSCR(COL, ROW)                                               
      INTEGER COL, ROW                                                          
C     Scroll viewport to show cell at COL, ROW                                  
                                                                                
C     Display state                                                             
      INTEGER DSPTOP, DSPLFT                                                    
      INTEGER DSPMOD                                                            
      COMMON /DSPDAT/ DSPTOP, DSPLFT, DSPMOD                                    
                                                                                
      INTEGER REDRAW                                                            
                                                                                
      REDRAW = 0                                                                
                                                                                
C     Check if row is visible (20 visible rows)                                 
      IF (ROW .LT. DSPTOP) THEN                                                 
C       Scroll up                                                               
        DSPTOP = ROW                                                            
        REDRAW = 1                                                              
      ELSE IF (ROW .GE. DSPTOP + 20) THEN                                       
C       Scroll down                                                             
        DSPTOP = ROW - 19                                                       
        REDRAW = 1                                                              
      END IF                                                                    
                                                                                
C     Check if column is visible (8 visible columns)                            
      IF (COL .LT. DSPLFT) THEN                                                 
C       Scroll left                                                             
        DSPLFT = COL                                                            
        REDRAW = 1                                                              
      ELSE IF (COL .GE. DSPLFT + 8) THEN                                        
C       Scroll right                                                            
        DSPLFT = COL - 7                                                        
        REDRAW = 1                                                              
      END IF                                                                    
                                                                                
C     Redraw if we scrolled                                                     
      IF (REDRAW .EQ. 1) THEN                                                   
        CALL DSPFUL                                                             
      END IF                                                                    
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     DSPMSG - Show message at bottom of screen                                 
C======================================================================         
      SUBROUTINE DSPMSG(MSG, LEN)                                               
      INTEGER MSG(*)                                                            
      INTEGER LEN                                                               
C     Display message at row 24 (overwrites edit line temporarily)              
                                                                                
C     Position at bottom                                                        
      CALL TMCURS(24, 1)                                                        
                                                                                
C     Show message                                                              
      CALL TMPUTS(MSG, LEN)                                                     
                                                                                
C     Clear rest of line                                                        
      CALL TMCEOL                                                               
                                                                                
C     Ring bell                                                                 
      CALL TMBELL                                                               
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     BLOCK DATA - Initialize display state                                     
C======================================================================         
      BLOCK DATA DSPIND                                                         
C     Initialize display viewport                                               
                                                                                
      INTEGER DSPTOP, DSPLFT                                                    
      INTEGER DSPMOD                                                            
                                                                                
      COMMON /DSPDAT/ DSPTOP, DSPLFT, DSPMOD                                    
                                                                                
      DATA DSPTOP /1/                                                           
      DATA DSPLFT /1/                                                           
      DATA DSPMOD /0/                                                           
                                                                                
      END                                                                       
:FILE                                                                           
:QUIT                                                                           
$                                                                               
$ RUN FORTRAN                                                                   
*SOURCE=DISPLAY.FOR                                                             
*OBJECT=DISPLAY.OBJ                                                             
*LINK                                                                           
$                                                                               
$ * Create and compile MSG.FOR                                                  
$ EDIT MSG.FOR                                                                  
C     MSG.FOR - Message String Module                                           
C                                                                               
C     Purpose: Store and retrieve application messages                          
C                                                                               
C     Features:                                                                 
C       - Error messages                                                        
C       - Help text                                                             
C       - Prompt strings                                                        
C       - Message categories                                                    
C                                                                               
C     Message Categories:                                                       
C       1 = Errors                                                              
C       2 = Help                                                                
C       3 = Prompts                                                             
C                                                                               
C     Storage:                                                                  
C       Each message stored as INTEGER array (ASCII codes)                      
C       Fixed maximum message length (80 characters)                            
C       Fixed number of messages per category (20)                              
C                                                                               
C     Dependencies: STRUTIL.FOR                                                 
C                                                                               
C     Author: Claude Code                                                       
C     Date: 2026-01-19                                                          
C                                                                               
C======================================================================         
                                                                                
C======================================================================         
C     MSGINI - Initialize message system                                        
C======================================================================         
      SUBROUTINE MSGINI                                                         
C     Initialize message storage with predefined messages                       
                                                                                
C     Error messages (category 1)                                               
      INTEGER ERR1(80), ERR2(80), ERR3(80), ERR4(80), ERR5(80)                  
      INTEGER ERRLEN(20)                                                        
                                                                                
C     Help messages (category 2)                                                
      INTEGER HLP1(80), HLP2(80), HLP3(80)                                      
      INTEGER HLPLEN(20)                                                        
                                                                                
C     Prompt messages (category 3)                                              
      INTEGER PRM1(80), PRM2(80), PRM3(80)                                      
      INTEGER PRMLEN(20)                                                        
                                                                                
      COMMON /MSGDAT/ ERR1, ERR2, ERR3, ERR4, ERR5, ERRLEN,                     
     &                HLP1, HLP2, HLP3, HLPLEN,                                 
     &                PRM1, PRM2, PRM3, PRMLEN                                  
                                                                                
      INTEGER I                                                                 
                                                                                
C     Clear all message lengths                                                 
      DO 10 I = 1, 20                                                           
        ERRLEN(I) = 0                                                           
        HLPLEN(I) = 0                                                           
        PRMLEN(I) = 0                                                           
10    CONTINUE                                                                  
                                                                                
C     Error Messages                                                            
C     Error 1: "Invalid formula"                                                
      DATA ERR1 /73, 110, 118, 97, 108, 105, 100, 32,                           
     &           102, 111, 114, 109, 117, 108, 97, 65*32/                       
      ERRLEN(1) = 15                                                            
                                                                                
C     Error 2: "Circular reference"                                             
      DATA ERR2 /67, 105, 114, 99, 117, 108, 97, 114, 32,                       
     &           114, 101, 102, 101, 114, 101, 110, 99, 101, 62*32/             
      ERRLEN(2) = 18                                                            
                                                                                
C     Error 3: "Division by zero"                                               
      DATA ERR3 /68, 105, 118, 105, 115, 105, 111, 110, 32,                     
     &           98, 121, 32, 122, 101, 114, 111, 64*32/                        
      ERRLEN(3) = 16                                                            
                                                                                
C     Error 4: "Out of memory"                                                  
      DATA ERR4 /79, 117, 116, 32, 111, 102, 32,                                
     &           109, 101, 109, 111, 114, 121, 67*32/                           
      ERRLEN(4) = 13                                                            
                                                                                
C     Error 5: "Cell not found"                                                 
      DATA ERR5 /67, 101, 108, 108, 32, 110, 111, 116, 32,                      
     &           102, 111, 117, 110, 100, 66*32/                                
      ERRLEN(5) = 14                                                            
                                                                                
C     Help Messages                                                             
C     Help 1: "XL Spreadsheet v1.0"                                             
      DATA HLP1 /88, 76, 32, 83, 112, 114, 101, 97, 100, 115,                   
     &           104, 101, 101, 116, 32, 118, 49, 46, 48, 61*32/                
      HLPLEN(1) = 19                                                            
                                                                                
C     Help 2: "Commands: /B /E /C /M /F /W /R /H /Q"                            
      DATA HLP2 /67, 111, 109, 109, 97, 110, 100, 115, 58, 32,                  
     &           47, 66, 32, 47, 69, 32, 47, 67, 32, 47, 77, 32,                
     &           47, 70, 32, 47, 87, 32, 47, 82, 32, 47, 72, 32,                
     &           47, 81, 44*32/                                                 
      HLPLEN(2) = 36                                                            
                                                                                
C     Help 3: "Press ? for help"                                                
      DATA HLP3 /80, 114, 101, 115, 115, 32, 63, 32,                            
     &           102, 111, 114, 32, 104, 101, 108, 112, 64*32/                  
      HLPLEN(3) = 16                                                            
                                                                                
C     Prompt Messages                                                           
C     Prompt 1: "Enter formula:"                                                
      DATA PRM1 /69, 110, 116, 101, 114, 32, 102, 111, 114, 109,                
     &           117, 108, 97, 58, 66*32/                                       
      PRMLEN(1) = 14                                                            
                                                                                
C     Prompt 2: "Command:"                                                      
      DATA PRM2 /67, 111, 109, 109, 97, 110, 100, 58, 72*32/                    
      PRMLEN(2) = 8                                                             
                                                                                
C     Prompt 3: "Cell:"                                                         
      DATA PRM3 /67, 101, 108, 108, 58, 75*32/                                  
      PRMLEN(3) = 5                                                             
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     MSGGET - Get message by category and number                               
C======================================================================         
      SUBROUTINE MSGGET(CAT, NUM, TEXT, TLEN)                                   
      INTEGER CAT, NUM                                                          
      INTEGER TEXT(80)                                                          
      INTEGER TLEN                                                              
                                                                                
C     Message storage                                                           
      INTEGER ERR1(80), ERR2(80), ERR3(80), ERR4(80), ERR5(80)                  
      INTEGER ERRLEN(20)                                                        
      INTEGER HLP1(80), HLP2(80), HLP3(80)                                      
      INTEGER HLPLEN(20)                                                        
      INTEGER PRM1(80), PRM2(80), PRM3(80)                                      
      INTEGER PRMLEN(20)                                                        
                                                                                
      COMMON /MSGDAT/ ERR1, ERR2, ERR3, ERR4, ERR5, ERRLEN,                     
     &                HLP1, HLP2, HLP3, HLPLEN,                                 
     &                PRM1, PRM2, PRM3, PRMLEN                                  
                                                                                
      INTEGER I                                                                 
                                                                                
C     Error messages (category 1)                                               
      IF (CAT .NE. 1) GO TO 100                                                 
                                                                                
      IF (NUM .EQ. 1) GO TO 10                                                  
      IF (NUM .EQ. 2) GO TO 20                                                  
      IF (NUM .EQ. 3) GO TO 30                                                  
      IF (NUM .EQ. 4) GO TO 40                                                  
      IF (NUM .EQ. 5) GO TO 50                                                  
      GO TO 900                                                                 
                                                                                
10    TLEN = ERRLEN(1)                                                          
      DO 11 I = 1, TLEN                                                         
        TEXT(I) = ERR1(I)                                                       
11    CONTINUE                                                                  
      RETURN                                                                    
                                                                                
20    TLEN = ERRLEN(2)                                                          
      DO 21 I = 1, TLEN                                                         
        TEXT(I) = ERR2(I)                                                       
21    CONTINUE                                                                  
      RETURN                                                                    
                                                                                
30    TLEN = ERRLEN(3)                                                          
      DO 31 I = 1, TLEN                                                         
        TEXT(I) = ERR3(I)                                                       
31    CONTINUE                                                                  
      RETURN                                                                    
                                                                                
40    TLEN = ERRLEN(4)                                                          
      DO 41 I = 1, TLEN                                                         
        TEXT(I) = ERR4(I)                                                       
41    CONTINUE                                                                  
      RETURN                                                                    
                                                                                
50    TLEN = ERRLEN(5)                                                          
      DO 51 I = 1, TLEN                                                         
        TEXT(I) = ERR5(I)                                                       
51    CONTINUE                                                                  
      RETURN                                                                    
                                                                                
C     Help messages (category 2)                                                
100   IF (CAT .NE. 2) GO TO 200                                                 
                                                                                
      IF (NUM .EQ. 1) GO TO 110                                                 
      IF (NUM .EQ. 2) GO TO 120                                                 
      IF (NUM .EQ. 3) GO TO 130                                                 
      GO TO 900                                                                 
                                                                                
110   TLEN = HLPLEN(1)                                                          
      DO 111 I = 1, TLEN                                                        
        TEXT(I) = HLP1(I)                                                       
111   CONTINUE                                                                  
      RETURN                                                                    
                                                                                
120   TLEN = HLPLEN(2)                                                          
      DO 121 I = 1, TLEN                                                        
        TEXT(I) = HLP2(I)                                                       
121   CONTINUE                                                                  
      RETURN                                                                    
                                                                                
130   TLEN = HLPLEN(3)                                                          
      DO 131 I = 1, TLEN                                                        
        TEXT(I) = HLP3(I)                                                       
131   CONTINUE                                                                  
      RETURN                                                                    
                                                                                
C     Prompt messages (category 3)                                              
200   IF (CAT .NE. 3) GO TO 900                                                 
                                                                                
      IF (NUM .EQ. 1) GO TO 210                                                 
      IF (NUM .EQ. 2) GO TO 220                                                 
      IF (NUM .EQ. 3) GO TO 230                                                 
      GO TO 900                                                                 
                                                                                
210   TLEN = PRMLEN(1)                                                          
      DO 211 I = 1, TLEN                                                        
        TEXT(I) = PRM1(I)                                                       
211   CONTINUE                                                                  
      RETURN                                                                    
                                                                                
220   TLEN = PRMLEN(2)                                                          
      DO 221 I = 1, TLEN                                                        
        TEXT(I) = PRM2(I)                                                       
221   CONTINUE                                                                  
      RETURN                                                                    
                                                                                
230   TLEN = PRMLEN(3)                                                          
      DO 231 I = 1, TLEN                                                        
        TEXT(I) = PRM3(I)                                                       
231   CONTINUE                                                                  
      RETURN                                                                    
                                                                                
C     Message not found                                                         
900   TLEN = 0                                                                  
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     MSGFMT - Format message with parameters (STUB for future)                 
C======================================================================         
      SUBROUTINE MSGFMT(CAT, NUM, PARAMS, NPRM, TEXT, TLEN)                     
      INTEGER CAT, NUM                                                          
      INTEGER PARAMS(10)                                                        
      INTEGER NPRM                                                              
      INTEGER TEXT(80)                                                          
      INTEGER TLEN                                                              
                                                                                
C     TODO: Implement message formatting with parameters                        
C     For now, just get the message without formatting                          
      CALL MSGGET(CAT, NUM, TEXT, TLEN)                                         
                                                                                
      RETURN                                                                    
      END                                                                       
:FILE                                                                           
:QUIT                                                                           
$                                                                               
$ RUN FORTRAN                                                                   
*SOURCE=MSG.FOR                                                                 
*OBJECT=MSG.OBJ                                                                 
*LINK                                                                           
$                                                                               
$ * Create and compile TERMCPV.FOR                                              
$ EDIT TERMCPV.FOR                                                              
C     TERMCPV.FOR - Terminal Driver for CP-V with VT-52 CRT                     
C                                                                               
C     Purpose: Platform-specific terminal I/O for Sigma CP-V                    
C                                                                               
C     Target: VT-52 compatible CRT terminals (1978 era)                         
C                                                                               
C     VT-52 Escape Sequences:                                                   
C       ESC H       - Home cursor (top-left)                                    
C       ESC J       - Clear to end of screen                                    
C       ESC K       - Clear to end of line                                      
C       ESC Y r c   - Direct cursor address (row+32, col+32)                    
C       ESC A       - Cursor up                                                 
C       ESC B       - Cursor down                                               
C       ESC C       - Cursor right                                              
C       ESC D       - Cursor left                                               
C       ESC I       - Reverse line feed                                         
C                                                                               
C     Special Keys:                                                             
C       ESC         - ASCII 27                                                  
C       RETURN      - ASCII 13                                                  
C       BACKSPACE   - ASCII 8 or 127                                            
C       Arrow keys  - ESC followed by A/B/C/D                                   
C                                                                               
C     Dependencies: None (pure terminal I/O)                                    
C                                                                               
C     Author: Claude Code                                                       
C     Date: 2026-01-19                                                          
C                                                                               
C     FORTRAN IV Notes:                                                         
C       - Uses FORMAT with A1 for character I/O                                 
C       - Terminal unit is 6 (standard output)                                  
C       - Input unit is 5 (standard input)                                      
C       - Non-advancing I/O via $ format (CP-V extension)                       
C                                                                               
C======================================================================         
                                                                                
C======================================================================         
C     TMINIT - Initialize terminal                                              
C======================================================================         
      SUBROUTINE TMINIT                                                         
C     Initialize terminal to known state                                        
C     Called once at program startup                                            
                                                                                
C     ESC sequence buffer                                                       
      INTEGER ESC, CH1, CH2                                                     
                                                                                
C     ASCII codes                                                               
      ESC = 27                                                                  
                                                                                
C     Send initialization sequence (if needed)                                  
C     VT-52 doesn't require init, but we clear screen                           
                                                                                
      CALL TMCLR                                                                
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMCLR - Clear screen                                                      
C======================================================================         
      SUBROUTINE TMCLR                                                          
C     Clear entire screen and home cursor                                       
C                                                                               
C     VT-52: ESC H (home) followed by ESC J (clear to end)                      
                                                                                
      INTEGER ESC, H, J                                                         
                                                                                
      ESC = 27                                                                  
      H = 72                                                                    
      J = 74                                                                    
                                                                                
C     Write ESC H (home cursor)                                                 
      WRITE(6,100) ESC, H                                                       
                                                                                
C     Write ESC J (clear to end of screen)                                      
      WRITE(6,100) ESC, J                                                       
                                                                                
100   FORMAT(2A1,$)                                                             
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMHOME - Home cursor (move to 1,1)                                        
C======================================================================         
      SUBROUTINE TMHOME                                                         
C     Move cursor to top-left corner (1,1)                                      
C                                                                               
C     VT-52: ESC H                                                              
                                                                                
      INTEGER ESC, H                                                            
                                                                                
      ESC = 27                                                                  
      H = 72                                                                    
                                                                                
      WRITE(6,100) ESC, H                                                       
                                                                                
100   FORMAT(2A1,$)                                                             
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMCURS - Position cursor                                                  
C======================================================================         
      SUBROUTINE TMCURS(ROW, COL)                                               
      INTEGER ROW, COL                                                          
C     Move cursor to specified position                                         
C                                                                               
C     VT-52: ESC Y row col                                                      
C     Where row and col are offset by 32 (space character)                      
C     Valid range: row 1-24, col 1-80                                           
                                                                                
      INTEGER ESC, Y                                                            
      INTEGER RCHAR, CCHAR                                                      
                                                                                
      ESC = 27                                                                  
      Y = 89                                                                    
                                                                                
C     Convert row/col to VT-52 format (add 31 for base-0 + space offset)        
      RCHAR = ROW + 31                                                          
      CCHAR = COL + 31                                                          
                                                                                
C     Write ESC Y row col                                                       
      WRITE(6,100) ESC, Y, RCHAR, CCHAR                                         
                                                                                
100   FORMAT(4A1,$)                                                             
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMCEOL - Clear to end of line                                             
C======================================================================         
      SUBROUTINE TMCEOL                                                         
C     Erase from cursor to end of current line                                  
C                                                                               
C     VT-52: ESC K                                                              
                                                                                
      INTEGER ESC, K                                                            
                                                                                
      ESC = 27                                                                  
      K = 75                                                                    
                                                                                
      WRITE(6,100) ESC, K                                                       
                                                                                
100   FORMAT(2A1,$)                                                             
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMCUP - Cursor up one line                                                
C======================================================================         
      SUBROUTINE TMCUP                                                          
C     Move cursor up one line                                                   
C                                                                               
C     VT-52: ESC A                                                              
                                                                                
      INTEGER ESC, A                                                            
                                                                                
      ESC = 27                                                                  
      A = 65                                                                    
                                                                                
      WRITE(6,100) ESC, A                                                       
                                                                                
100   FORMAT(2A1,$)                                                             
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMCDN - Cursor down one line                                              
C======================================================================         
      SUBROUTINE TMCDN                                                          
C     Move cursor down one line                                                 
C                                                                               
C     VT-52: ESC B                                                              
                                                                                
      INTEGER ESC, B                                                            
                                                                                
      ESC = 27                                                                  
      B = 66                                                                    
                                                                                
      WRITE(6,100) ESC, B                                                       
                                                                                
100   FORMAT(2A1,$)                                                             
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMCRT - Cursor right one column                                           
C======================================================================         
      SUBROUTINE TMCRT                                                          
C     Move cursor right one column                                              
C                                                                               
C     VT-52: ESC C                                                              
                                                                                
      INTEGER ESC, C                                                            
                                                                                
      ESC = 27                                                                  
      C = 67                                                                    
                                                                                
      WRITE(6,100) ESC, C                                                       
                                                                                
100   FORMAT(2A1,$)                                                             
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMCLFT - Cursor left one column                                           
C======================================================================         
      SUBROUTINE TMCLFT                                                         
C     Move cursor left one column                                               
C                                                                               
C     VT-52: ESC D                                                              
                                                                                
      INTEGER ESC, D                                                            
                                                                                
      ESC = 27                                                                  
      D = 68                                                                    
                                                                                
      WRITE(6,100) ESC, D                                                       
                                                                                
100   FORMAT(2A1,$)                                                             
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMPUTC - Write single character at current position                       
C======================================================================         
      SUBROUTINE TMPUTC(CH)                                                     
      INTEGER CH                                                                
C     Write character without advancing to next line                            
C     Character stays at current cursor position                                
                                                                                
      WRITE(6,100) CH                                                           
                                                                                
100   FORMAT(A1,$)                                                              
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMPUTS - Write string at current position                                 
C======================================================================         
      SUBROUTINE TMPUTS(STR, LEN)                                               
      INTEGER STR(*)                                                            
      INTEGER LEN                                                               
C     Write string of LENGTH characters                                         
C     Does not advance to next line                                             
                                                                                
      INTEGER I                                                                 
                                                                                
      DO 10 I = 1, LEN                                                          
        WRITE(6,100) STR(I)                                                     
10    CONTINUE                                                                  
                                                                                
100   FORMAT(A1,$)                                                              
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMPUTN - Write integer at current position                                
C======================================================================         
      SUBROUTINE TMPUTN(NUM)                                                    
      INTEGER NUM                                                               
C     Write integer value                                                       
C     Does not advance to next line                                             
                                                                                
      WRITE(6,100) NUM                                                          
                                                                                
100   FORMAT(I6,$)                                                              
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMPUTR - Write REAL at current position                                   
C======================================================================         
      SUBROUTINE TMPUTR(NUM, PREC)                                              
      REAL NUM                                                                  
      INTEGER PREC                                                              
C     Write REAL value with PREC decimal places                                 
C     Does not advance to next line                                             
C     PREC: 0-6 decimal places                                                  
                                                                                
      IF (PREC .EQ. 0) THEN                                                     
        WRITE(6,100) NUM                                                        
      ELSE IF (PREC .EQ. 1) THEN                                                
        WRITE(6,101) NUM                                                        
      ELSE IF (PREC .EQ. 2) THEN                                                
        WRITE(6,102) NUM                                                        
      ELSE IF (PREC .EQ. 3) THEN                                                
        WRITE(6,103) NUM                                                        
      ELSE IF (PREC .EQ. 4) THEN                                                
        WRITE(6,104) NUM                                                        
      ELSE IF (PREC .EQ. 5) THEN                                                
        WRITE(6,105) NUM                                                        
      ELSE                                                                      
        WRITE(6,106) NUM                                                        
      END IF                                                                    
                                                                                
100   FORMAT(F10.0,$)                                                           
101   FORMAT(F10.1,$)                                                           
102   FORMAT(F10.2,$)                                                           
103   FORMAT(F10.3,$)                                                           
104   FORMAT(F10.4,$)                                                           
105   FORMAT(F10.5,$)                                                           
106   FORMAT(F10.6,$)                                                           
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMKEY - Read single keystroke (non-blocking attempt)                      
C======================================================================         
      SUBROUTINE TMKEY(KEY, VALID)                                              
      INTEGER KEY                                                               
      INTEGER VALID                                                             
C     Read a single keystroke from terminal                                     
C     KEY: ASCII code of key pressed                                            
C     VALID: 1 if key read, 0 if no key available                               
C                                                                               
C     Special handling:                                                         
C       - Arrow keys: ESC followed by A/B/C/D                                   
C       - Returns special codes 128+ for arrows                                 
C       - ESC alone: 27                                                         
C       - RETURN: 13                                                            
C       - BACKSPACE: 8 or 127                                                   
                                                                                
C     Key state                                                                 
      INTEGER LASKEY, ESCSQ                                                     
      COMMON /TMKDAT/ LASKEY, ESCSQ                                             
                                                                                
      INTEGER CH                                                                
      INTEGER IOS                                                               
                                                                                
C     Try to read character (non-blocking)                                      
C     Note: FORTRAN IV doesn't have true non-blocking I/O                       
C     This is a simplified version that blocks on input                         
                                                                                
      READ(5,100,IOSTAT=IOS) CH                                                 
                                                                                
C     Check for error or EOF                                                    
      IF (IOS .NE. 0) THEN                                                      
        VALID = 0                                                               
        KEY = 0                                                                 
        RETURN                                                                  
      END IF                                                                    
                                                                                
      VALID = 1                                                                 
                                                                                
C     Check if we're in escape sequence                                         
      IF (ESCSQ .EQ. 1) THEN                                                    
C       Second character of escape sequence                                     
        ESCSQ = 0                                                               
                                                                                
C       Check for arrow keys                                                    
        IF (CH .EQ. 65) THEN                                                    
C         ESC A = Up arrow                                                      
          KEY = 128                                                             
        ELSE IF (CH .EQ. 66) THEN                                               
C         ESC B = Down arrow                                                    
          KEY = 129                                                             
        ELSE IF (CH .EQ. 67) THEN                                               
C         ESC C = Right arrow                                                   
          KEY = 130                                                             
        ELSE IF (CH .EQ. 68) THEN                                               
C         ESC D = Left arrow                                                    
          KEY = 131                                                             
        ELSE                                                                    
C         Unknown escape sequence, return ESC                                   
          KEY = 27                                                              
        END IF                                                                  
                                                                                
        RETURN                                                                  
      END IF                                                                    
                                                                                
C     Check if this starts an escape sequence                                   
      IF (CH .EQ. 27) THEN                                                      
        ESCSQ = 1                                                               
        LASKEY = CH                                                             
C       Need to read next character, so recurse                                 
C       (In real implementation, would buffer)                                  
        CALL TMKEY(KEY, VALID)                                                  
        RETURN                                                                  
      END IF                                                                    
                                                                                
C     Normal character                                                          
      KEY = CH                                                                  
                                                                                
100   FORMAT(A1)                                                                
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMWAIT - Wait for keypress                                                
C======================================================================         
      SUBROUTINE TMWAIT(KEY)                                                    
      INTEGER KEY                                                               
C     Wait for a keypress and return it                                         
C     Blocks until key is pressed                                               
                                                                                
      INTEGER VALID                                                             
                                                                                
C     Loop until we get a key                                                   
10    CALL TMKEY(KEY, VALID)                                                    
      IF (VALID .EQ. 0) GO TO 10                                                
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMBELL - Ring terminal bell                                               
C======================================================================         
      SUBROUTINE TMBELL                                                         
C     Sound terminal bell (ASCII 7)                                             
                                                                                
      INTEGER BELL                                                              
                                                                                
      BELL = 7                                                                  
                                                                                
      WRITE(6,100) BELL                                                         
                                                                                
100   FORMAT(A1,$)                                                              
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMRVON - Reverse video ON (if supported)                                  
C======================================================================         
      SUBROUTINE TMRVON                                                         
C     Enable reverse video                                                      
C     VT-52 doesn't have this, so no-op                                         
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMRVOF - Reverse video OFF                                                
C======================================================================         
      SUBROUTINE TMRVOF                                                         
C     Disable reverse video                                                     
C     VT-52 doesn't have this, so no-op                                         
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMFLSH - Flush output buffer                                              
C======================================================================         
      SUBROUTINE TMFLSH                                                         
C     Ensure all output is sent to terminal                                     
C     Forces write to complete                                                  
                                                                                
C     CP-V specific: flush unit 6                                               
C     In FORTRAN IV, this is typically automatic                                
C     but we provide the hook for platforms that need it                        
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     TMLINE - Draw horizontal line                                             
C======================================================================         
      SUBROUTINE TMLINE(LEN)                                                    
      INTEGER LEN                                                               
C     Draw horizontal line of dashes                                            
C     Used for borders and separators                                           
                                                                                
      INTEGER I                                                                 
      INTEGER DASH                                                              
                                                                                
      DASH = 45                                                                 
                                                                                
      DO 10 I = 1, LEN                                                          
        WRITE(6,100) DASH                                                       
10    CONTINUE                                                                  
                                                                                
100   FORMAT(A1,$)                                                              
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     BLOCK DATA - Initialize terminal state                                    
C======================================================================         
      BLOCK DATA TMINID                                                         
C     Initialize terminal key state                                             
                                                                                
      INTEGER LASKEY, ESCSQ                                                     
      COMMON /TMKDAT/ LASKEY, ESCSQ                                             
                                                                                
      DATA LASKEY /0/                                                           
      DATA ESCSQ /0/                                                            
                                                                                
      END                                                                       
:FILE                                                                           
:QUIT                                                                           
$                                                                               
$ RUN FORTRAN                                                                   
*SOURCE=TERMCPV.FOR                                                             
*OBJECT=TERMCPV.OBJ                                                             
*LINK                                                                           
$                                                                               
$ * Create and compile XLMAIN.FOR                                               
$ EDIT XLMAIN.FOR                                                               
C     XLMAIN.FOR - XL Spreadsheet Main Program                                  
C                                                                               
C     Purpose: Interactive spreadsheet for CP-V with VT-52 terminal             
C                                                                               
C     Features:                                                                 
C       - Full-screen grid display                                              
C       - Cell navigation with arrow keys                                       
C       - Formula entry and evaluation                                          
C       - Automatic recalculation                                               
C       - Slash commands (future)                                               
C                                                                               
C     Target: Xerox Sigma 7 CP-V with VT-52 CRT terminal                        
C                                                                               
C     Usage:                                                                    
C       $ RUN XL                                                                
C                                                                               
C     Exit:                                                                     
C       Type /QUIT and press RETURN                                             
C                                                                               
C     Author: Claude Code                                                       
C     Date: 2026-01-19                                                          
C                                                                               
C     FORTRAN IV Notes:                                                         
C       - Fixed-format source (columns 1-72)                                    
C       - Arithmetic IF only                                                    
C       - GO TO for control flow                                                
C       - No PARAMETER in main program (F66 limitation)                         
C                                                                               
C======================================================================         
                                                                                
      PROGRAM XL                                                                
C     XL Spreadsheet - Interactive calculation system                           
                                                                                
C     System state                                                              
      INTEGER MODE, COL, ROW                                                    
      INTEGER KEY, VALID                                                        
      INTEGER RUNNING                                                           
                                                                                
C     Welcome message                                                           
      INTEGER WELMSG(40)                                                        
      INTEGER WELLEN                                                            
                                                                                
C     Initialize all subsystems                                                 
      CALL CELINI                                                               
      CALL DEPINI                                                               
      CALL UIINI                                                                
      CALL DSPINI                                                               
                                                                                
C     Display welcome                                                           
      DATA WELMSG /88,76,32,83,112,114,101,97,100,115,                          
     &             104,101,101,116,32,118,49,46,48,32,                          
     &             45,32,67,80,45,86,47,86,84,45,53,50,                         
     &             32,32,32,32,32,32,32,32/                                     
      WELLEN = 32                                                               
                                                                                
C     Show welcome at bottom of screen                                          
      CALL DSPMSG(WELMSG, WELLEN)                                               
                                                                                
C     Wait 2 seconds (poor man's delay - loop)                                  
C     Note: This is platform-dependent, adjust for CP-V                         
      DO 5 KEY = 1, 100000                                                      
5     CONTINUE                                                                  
                                                                                
C     Draw initial screen                                                       
      CALL DSPFUL                                                               
                                                                                
C     Main event loop                                                           
      RUNNING = 1                                                               
                                                                                
10    IF (RUNNING .EQ. 0) GO TO 999                                             
                                                                                
C       Read keystroke                                                          
        CALL TMKEY(KEY, VALID)                                                  
                                                                                
C       Check if key available                                                  
        IF (VALID .EQ. 0) GO TO 10                                              
                                                                                
C       Get current state                                                       
        CALL UIGET(MODE, COL, ROW)                                              
                                                                                
C       Handle keystroke based on mode                                          
        IF (MODE .EQ. 1) THEN                                                   
C         NAV mode                                                              
          CALL NAVKEY(KEY, RUNNING)                                             
                                                                                
        ELSE IF (MODE .EQ. 2) THEN                                              
C         ENTRY mode                                                            
          CALL ENTKEY(KEY)                                                      
                                                                                
        ELSE IF (MODE .EQ. 4) THEN                                              
C         COMMAND mode                                                          
          CALL CMDKEY(KEY, RUNNING)                                             
                                                                                
        END IF                                                                  
                                                                                
C       Scroll viewport if needed                                               
        CALL UIGET(MODE, COL, ROW)                                              
        CALL DSPSCR(COL, ROW)                                                   
                                                                                
C       Refresh display                                                         
        CALL DSPFUL                                                             
                                                                                
C       Continue loop                                                           
        GO TO 10                                                                
                                                                                
999   CONTINUE                                                                  
                                                                                
C     Clean shutdown                                                            
      CALL TMCLR                                                                
      CALL TMHOME                                                               
                                                                                
      STOP                                                                      
      END                                                                       
                                                                                
C======================================================================         
C     NAVKEY - Handle keystroke in NAV mode                                     
C======================================================================         
      SUBROUTINE NAVKEY(KEY, RUNNING)                                           
      INTEGER KEY                                                               
      INTEGER RUNNING                                                           
C     Process keystroke in navigation mode                                      
C                                                                               
C     Arrow keys: 128=Up, 129=Down, 130=Right, 131=Left                         
C     /: Enter COMMAND mode                                                     
C     Printable char: Enter ENTRY mode                                          
                                                                                
C     UI state                                                                  
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
C     Check for arrow keys                                                      
      IF (KEY .EQ. 128) THEN                                                    
C       Up arrow                                                                
        IF (UIROW .GT. 1) THEN                                                  
          UIROW = UIROW - 1                                                     
        END IF                                                                  
                                                                                
      ELSE IF (KEY .EQ. 129) THEN                                               
C       Down arrow                                                              
        IF (UIROW .LT. 254) THEN                                                
          UIROW = UIROW + 1                                                     
        END IF                                                                  
                                                                                
      ELSE IF (KEY .EQ. 130) THEN                                               
C       Right arrow                                                             
        IF (UICOL .LT. 26) THEN                                                 
          UICOL = UICOL + 1                                                     
        END IF                                                                  
                                                                                
      ELSE IF (KEY .EQ. 131) THEN                                               
C       Left arrow                                                              
        IF (UICOL .GT. 1) THEN                                                  
          UICOL = UICOL - 1                                                     
        END IF                                                                  
                                                                                
C     Check for slash (command mode)                                            
      ELSE IF (KEY .EQ. 47) THEN                                                
C       Enter COMMAND mode                                                      
        CUMODE = 4                                                              
        UIBLEN = 0                                                              
                                                                                
C     Check for printable characters (start ENTRY mode)                         
      ELSE IF (KEY .GE. 32 .AND. KEY .LE. 126) THEN                             
C       Enter ENTRY mode                                                        
        CUMODE = 2                                                              
        UIBLEN = 1                                                              
        INBUF(1) = KEY                                                          
                                                                                
      END IF                                                                    
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     ENTKEY - Handle keystroke in ENTRY mode                                   
C======================================================================         
      SUBROUTINE ENTKEY(KEY)                                                    
      INTEGER KEY                                                               
C     Process keystroke in entry mode                                           
C                                                                               
C     RETURN (13): Finish entry, evaluate, return to NAV                        
C     ESC (27): Cancel entry, return to NAV                                     
C     BACKSPACE (8/127): Delete last character                                  
C     Printable: Add to buffer                                                  
                                                                                
C     UI state                                                                  
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
      REAL VALUE                                                                
      INTEGER CTYPE                                                             
      INTEGER TOKENS(100, 4)                                                    
      INTEGER NTOK                                                              
      INTEGER DEPS(100, 2)                                                      
      INTEGER NDEPS                                                             
      INTEGER ERR                                                               
                                                                                
C     Check for RETURN                                                          
      IF (KEY .EQ. 13) THEN                                                     
C       Finish entry                                                            
                                                                                
        IF (UIBLEN .GT. 0) THEN                                                 
C         Try to parse as formula                                               
          CALL PARSE(INBUF, UIBLEN, TOKENS, 100, NTOK,                          
     &               DEPS, 100, NDEPS, ERR)                                     
                                                                                
          IF (ERR .EQ. 0 .AND. NTOK .GT. 0) THEN                                
C           Valid formula - evaluate and store                                  
            CALL EVAL(TOKENS, NTOK, VALUE, ERR)                                 
                                                                                
            IF (ERR .EQ. 0) THEN                                                
C             Store result                                                      
              CALL CELPUT(UICOL, UIROW, 2, VALUE)                               
                                                                                
C             Store formula                                                     
              CALL CELPTK(UICOL, UIROW, INBUF, UIBLEN)                          
                                                                                
C             Add dependencies                                                  
              CALL DEPSAD(UICOL, UIROW, DEPS, NDEPS)                            
                                                                                
C             Recalculate dependents                                            
              CALL RECALC(UICOL, UIROW)                                         
            END IF                                                              
          ELSE                                                                  
C           Try as plain number                                                 
            VALUE = ATOR(INBUF, UIBLEN)                                         
            CALL CELPUT(UICOL, UIROW, 1, VALUE)                                 
          END IF                                                                
        END IF                                                                  
                                                                                
C       Return to NAV mode                                                      
        CUMODE = 1                                                              
        UIBLEN = 0                                                              
                                                                                
C     Check for ESC                                                             
      ELSE IF (KEY .EQ. 27) THEN                                                
C       Cancel entry                                                            
        CUMODE = 1                                                              
        UIBLEN = 0                                                              
                                                                                
C     Check for BACKSPACE                                                       
      ELSE IF (KEY .EQ. 8 .OR. KEY .EQ. 127) THEN                               
        IF (UIBLEN .GT. 0) THEN                                                 
          UIBLEN = UIBLEN - 1                                                   
        END IF                                                                  
                                                                                
C     Check for printable characters                                            
      ELSE IF (KEY .GE. 32 .AND. KEY .LE. 126) THEN                             
        IF (UIBLEN .LT. 80) THEN                                                
          UIBLEN = UIBLEN + 1                                                   
          INBUF(UIBLEN) = KEY                                                   
        END IF                                                                  
                                                                                
      END IF                                                                    
                                                                                
      RETURN                                                                    
      END                                                                       
                                                                                
C======================================================================         
C     CMDKEY - Handle keystroke in COMMAND mode                                 
C======================================================================         
      SUBROUTINE CMDKEY(KEY, RUNNING)                                           
      INTEGER KEY                                                               
      INTEGER RUNNING                                                           
C     Process keystroke in command mode                                         
C                                                                               
C     RETURN: Execute command                                                   
C     ESC: Cancel command                                                       
C     BACKSPACE: Delete character                                               
C     Printable: Add to buffer                                                  
                                                                                
C     UI state                                                                  
      INTEGER CUMODE, UICOL, UIROW                                              
      INTEGER INBUF(80), UIBLEN                                                 
      INTEGER UIFRM(80), UIFLEN                                                 
      COMMON /UIDAT/ CUMODE, UICOL, UIROW,                                      
     &               INBUF, UIBLEN,                                             
     &               UIFRM, UIFLEN                                              
                                                                                
C     Command: QUIT (Q,U,I,T = 81,85,73,84)                                     
      INTEGER QCMD(4)                                                           
      DATA QCMD /81,85,73,84/                                                   
                                                                                
      INTEGER I, MATCH                                                          
                                                                                
C     Check for RETURN                                                          
      IF (KEY .EQ. 13) THEN                                                     
C       Execute command                                                         
                                                                                
C       Check for QUIT                                                          
        IF (UIBLEN .EQ. 4) THEN                                                 
          MATCH = 1                                                             
          DO 10 I = 1, 4                                                        
            IF (INBUF(I) .NE. QCMD(I)) THEN                                     
              MATCH = 0                                                         
            END IF                                                              
10        CONTINUE                                                              
                                                                                
          IF (MATCH .EQ. 1) THEN                                                
C           Quit command                                                        
            RUNNING = 0                                                         
            RETURN                                                              
          END IF                                                                
        END IF                                                                  
                                                                                
C       Unknown command - ignore                                                
        CUMODE = 1                                                              
        UIBLEN = 0                                                              
                                                                                
C     Check for ESC                                                             
      ELSE IF (KEY .EQ. 27) THEN                                                
        CUMODE = 1                                                              
        UIBLEN = 0                                                              
                                                                                
C     Check for BACKSPACE                                                       
      ELSE IF (KEY .EQ. 8 .OR. KEY .EQ. 127) THEN                               
        IF (UIBLEN .GT. 0) THEN                                                 
          UIBLEN = UIBLEN - 1                                                   
        END IF                                                                  
                                                                                
C     Check for printable characters                                            
      ELSE IF (KEY .GE. 32 .AND. KEY .LE. 126) THEN                             
        IF (UIBLEN .LT. 80) THEN                                                
          UIBLEN = UIBLEN + 1                                                   
          INBUF(UIBLEN) = KEY                                                   
        END IF                                                                  
                                                                                
      END IF                                                                    
                                                                                
      RETURN                                                                    
      END                                                                       
:FILE                                                                           
:QUIT                                                                           
$                                                                               
$ RUN FORTRAN                                                                   
*SOURCE=XLMAIN.FOR                                                              
*OBJECT=XLMAIN.OBJ                                                              
*LIBRARY=STRUTIL,CELLS,DEPS,PARSE,EVAL,RECALC,UI,DISPLAY,MSG,TERMCPV            
*LINK                                                                           
*MAP                                                                            
*GO                                                                             
$                                                                               
$ * Save executable                                                             
$ SAVE XL                                                                       
$                                                                               
$ EOJ                                                                           
